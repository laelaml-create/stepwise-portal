<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StepWise — Participant Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400;1,600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #root { height: 100%; width: 100%; }

    :root {
      --cream: #FAF9F7;
      --cream-dark: #F2EFEA;
      --text-primary: #21242C;
      --text-secondary: #8A8580;
      --text-muted: #B5B0A8;
      --border: #EBE7E0;
      --input-line: #D4CFC7;
      --brand-amber: #F5A623;
      --brand-red: #E8573A;
      --brand-purple: #7B2D8E;
      --success: #22c55e;
      --error: #E8573A;
      --white: #FFFFFF;
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--cream);
      color: var(--text-primary);
      background-image:
        linear-gradient(rgba(0,0,0,0.025) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.025) 1px, transparent 1px);
      background-size: 48px 48px;
    }

    /* Typography */
    .heading-serif { font-family: 'Playfair Display', Georgia, serif; }
    .heading-serif-italic { font-family: 'Playfair Display', Georgia, serif; font-style: italic; }

    /* Top Nav Bar */
    .top-nav {
      background: var(--white);
      border-bottom: 1px solid var(--border);
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 60px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-name {
      font-family: 'DM Sans', sans-serif;
      font-weight: 700;
      font-size: 18px;
      color: var(--text-primary);
      letter-spacing: -0.3px;
      text-decoration: none;
    }
    .brand-name:hover { opacity: 0.8; }
    .brand-dots {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .brand-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .brand-dot.amber { background: var(--brand-amber); }
    .brand-dot.red { background: var(--brand-red); }
    .brand-dot.purple { background: var(--brand-purple); }
    .nav-links {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .nav-link {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      text-decoration: none;
      padding: 8px 14px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .nav-link:hover {
      color: var(--text-primary);
      background: var(--cream-dark);
    }
    .nav-link.active {
      color: var(--brand-amber);
      font-weight: 600;
    }
    .nav-mobile-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: var(--text-primary);
      padding: 4px;
    }
    .nav-mobile-menu {
      display: none;
      position: absolute;
      top: 60px;
      left: 0;
      right: 0;
      background: var(--white);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      flex-direction: column;
      gap: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    .nav-mobile-menu.open { display: flex; }
    .nav-mobile-menu .nav-link {
      padding: 10px 14px;
      font-size: 14px;
    }
    @media (max-width: 700px) {
      .top-nav { padding: 0 20px; }
      .nav-links { display: none; }
      .nav-mobile-toggle { display: block; }
    }

    /* Brand Header (used inside cards) */
    .brand-bar {
      padding: 24px 32px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Page Container */
    .page-container {
      max-width: 680px;
      margin: 0 auto;
      padding: 0 24px 80px;
    }

    /* Page Title */
    .page-title {
      text-align: center;
      margin-bottom: 8px;
    }
    .page-title h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-style: italic;
      font-weight: 600;
      font-size: 42px;
      color: var(--text-primary);
      line-height: 1.15;
    }
    .page-subtitle {
      text-align: center;
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 40px;
      line-height: 1.6;
    }

    /* Section Title */
    .section-title {
      text-align: center;
      margin-bottom: 8px;
    }
    .section-title h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-weight: 600;
      font-size: 28px;
      color: var(--text-primary);
    }
    .section-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--brand-amber);
      text-align: center;
      margin-bottom: 6px;
    }

    /* Step Progress Bar */
    .step-progress-wrapper {
      text-align: center;
      margin-bottom: 32px;
    }
    .step-counter {
      font-size: 14px;
      font-weight: 600;
      color: var(--brand-amber);
      margin-bottom: 12px;
    }
    .step-bar {
      display: flex;
      gap: 6px;
      max-width: 320px;
      margin: 0 auto;
    }
    .step-segment {
      flex: 1;
      height: 5px;
      border-radius: 3px;
      background: var(--border);
      transition: background 0.4s ease;
    }
    .step-segment.active { background: var(--brand-red); }
    .step-segment.done { background: var(--brand-amber); }

    /* Conversational Form */
    .form-section {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px 36px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .conv-line {
      font-size: 18px;
      line-height: 2.4;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .conv-line .inline-input {
      border: none;
      border-bottom: 2px solid var(--input-line);
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      padding: 2px 6px;
      min-width: 120px;
      outline: none;
      transition: border-color 0.3s;
    }
    .conv-line .inline-input:focus {
      border-bottom-color: var(--brand-amber);
    }
    .conv-line .inline-input::placeholder {
      color: var(--text-muted);
      font-weight: 400;
    }
    .conv-line .inline-input.wide { min-width: 240px; }
    .conv-line .inline-input.date-part { min-width: 50px; max-width: 60px; text-align: center; }
    .conv-line .inline-input.date-part.year { min-width: 70px; max-width: 80px; }

    .conv-line .read-only-value {
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      padding: 2px 6px;
    }

    /* Block textarea for longer inputs */
    .conv-textarea-label {
      font-size: 17px;
      color: var(--text-primary);
      margin-bottom: 10px;
      line-height: 1.5;
    }
    .conv-textarea {
      width: 100%;
      min-height: 90px;
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      color: var(--text-primary);
      background: var(--cream);
      resize: vertical;
      outline: none;
      transition: border-color 0.3s;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    .conv-textarea:focus {
      border-color: var(--brand-amber);
      background: var(--white);
    }
    .conv-textarea::placeholder {
      color: var(--text-muted);
    }

    /* Buttons */
    .btn-continue {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 32px;
      border: 2px solid var(--text-primary);
      border-radius: 40px;
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.25s;
    }
    .btn-continue:hover {
      background: var(--text-primary);
      color: var(--white);
    }
    .btn-continue:active { transform: scale(0.97); }
    .btn-continue:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .btn-continue:disabled:hover {
      background: transparent;
      color: var(--text-primary);
    }

    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      border: none;
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: color 0.2s;
    }
    .btn-back:hover { color: var(--text-primary); }

    .btn-primary-fill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 36px;
      border: none;
      border-radius: 40px;
      background: var(--brand-amber);
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      font-weight: 600;
      color: var(--white);
      cursor: pointer;
      transition: all 0.25s;
      box-shadow: 0 2px 8px rgba(245,166,35,0.3);
    }
    .btn-primary-fill:hover {
      background: #e0950e;
      box-shadow: 0 4px 16px rgba(245,166,35,0.35);
    }
    .btn-primary-fill:active { transform: scale(0.97); }
    .btn-primary-fill:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-nav-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-top: 32px;
    }

    /* Login-specific */
    .login-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 48px 40px;
      max-width: 480px;
      margin: 40px auto 0;
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
      text-align: center;
    }
    .login-card h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .login-card p {
      color: var(--text-secondary);
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 32px;
    }
    .login-email-row {
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 28px;
      line-height: 2.4;
    }
    .login-email-input {
      border: none;
      border-bottom: 2px solid var(--input-line);
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      padding: 4px 8px;
      min-width: 260px;
      outline: none;
      transition: border-color 0.3s;
      text-align: center;
    }
    .login-email-input:focus { border-bottom-color: var(--brand-amber); }
    .login-email-input::placeholder { color: var(--text-muted); font-weight: 400; }

    /* Check Email */
    .check-email-icon {
      font-size: 56px;
      margin-bottom: 20px;
    }

    /* Success */
    .success-icon { font-size: 64px; margin-bottom: 16px; }

    /* Not Found */
    .not-found-icon { font-size: 48px; margin-bottom: 16px; }

    /* Review Section */
    .review-card {
      background: var(--cream);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 16px;
    }
    .review-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--brand-amber);
      margin-bottom: 6px;
    }
    .review-value {
      font-size: 15px;
      color: var(--text-primary);
      line-height: 1.6;
    }
    .review-value.empty {
      color: var(--text-muted);
      font-style: italic;
    }
    .review-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Alert Banner */
    .alert-banner {
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .alert-banner.error {
      background: rgba(232,87,58,0.08);
      color: var(--brand-red);
      border: 1px solid rgba(232,87,58,0.15);
    }
    .alert-banner.success {
      background: rgba(34,197,94,0.08);
      color: var(--success);
      border: 1px solid rgba(34,197,94,0.15);
    }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2.5px solid rgba(245,166,35,0.25);
      border-top-color: var(--brand-amber);
      border-radius: 50%;
      animation: spin 0.65s linear infinite;
    }
    .spinner.white {
      border-color: rgba(255,255,255,0.3);
      border-top-color: white;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Decorative gradient line */
    .gradient-line {
      height: 4px;
      border-radius: 2px;
      background: linear-gradient(90deg, var(--brand-amber), var(--brand-red), var(--brand-purple));
      margin-bottom: 28px;
    }

    /* Fade animations */
    .fade-in {
      animation: fadeIn 0.4s ease forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Sign-out link */
    .signout-link {
      position: fixed;
      bottom: 20px;
      right: 24px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      border: none;
      background: none;
      font-family: 'DM Sans', sans-serif;
      transition: color 0.2s;
    }
    .signout-link:hover { color: var(--text-secondary); }

    /* Training badge */
    .training-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--cream-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    /* Chip Select Grid */
    .chip-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .chip-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      user-select: none;
    }
    .chip-option:hover {
      border-color: var(--text-muted);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .chip-option.selected {
      border-width: 2px;
      font-weight: 600;
    }
    .chip-option .chip-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
      border: 2px solid currentColor;
      transition: all 0.2s;
    }
    .chip-option.selected .chip-dot {
      border: none;
      width: 12px;
      height: 12px;
    }
    /* Color themes for chip groups */
    .chip-option.color-amber.selected { border-color: var(--brand-amber); background: #FFF9F0; color: #B8760A; }
    .chip-option.color-amber .chip-dot { border-color: var(--brand-amber); }
    .chip-option.color-amber.selected .chip-dot { background: var(--brand-amber); }

    .chip-option.color-red.selected { border-color: var(--brand-red); background: #FEF2F0; color: #B83D25; }
    .chip-option.color-red .chip-dot { border-color: var(--brand-red); }
    .chip-option.color-red.selected .chip-dot { background: var(--brand-red); }

    .chip-option.color-purple.selected { border-color: var(--brand-purple); background: #F8F0FA; color: #5E1D6E; }
    .chip-option.color-purple .chip-dot { border-color: var(--brand-purple); }
    .chip-option.color-purple.selected .chip-dot { background: var(--brand-purple); }

    .chip-option.color-teal.selected { border-color: #0D9488; background: #F0FDFA; color: #0F766E; }
    .chip-option.color-teal .chip-dot { border-color: #0D9488; }
    .chip-option.color-teal.selected .chip-dot { background: #0D9488; }

    .chip-option.color-blue.selected { border-color: #3B82F6; background: #EFF6FF; color: #1D4ED8; }
    .chip-option.color-blue .chip-dot { border-color: #3B82F6; }
    .chip-option.color-blue.selected .chip-dot { background: #3B82F6; }

    .chip-option.color-rose.selected { border-color: #E11D48; background: #FFF1F2; color: #BE123C; }
    .chip-option.color-rose .chip-dot { border-color: #E11D48; }
    .chip-option.color-rose.selected .chip-dot { background: #E11D48; }

    .chip-other-input {
      width: 100%;
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      color: var(--text-primary);
      background: var(--cream);
      outline: none;
      transition: border-color 0.3s;
      margin-top: -10px;
      margin-bottom: 20px;
    }
    .chip-other-input:focus {
      border-color: var(--brand-amber);
      background: var(--white);
    }
    .chip-other-input::placeholder { color: var(--text-muted); }

    /* Responsive */
    @media (max-width: 600px) {
      .brand-bar { padding: 16px 20px; }
      .page-container { padding: 0 16px 60px; }
      .page-title h1 { font-size: 32px; }
      .form-section { padding: 28px 24px; }
      .conv-line { font-size: 16px; }
      .conv-line .inline-input { font-size: 16px; min-width: 100px; }
      .conv-line .inline-input.wide { min-width: 180px; }
      .login-card { padding: 32px 24px; margin-top: 40px; }
      .login-email-input { min-width: 200px; font-size: 16px; }
      .review-row { grid-template-columns: 1fr; }
      .chip-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .chip-option { padding: 10px 12px; font-size: 13px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;
    const { createClient } = window.supabase;

    /* ── CONFIG ── */
    const SUPABASE_URL = 'https://ybludwecmqghoheotzzz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlibHVkd2VjbXFnaG9oZW90enp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MzI4MzMsImV4cCI6MjA4NjAwODgzM30._wND5hmDkd4sh7clXaBPZP0lU-c6Traz0KzlYyPxKWk';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ── HELPERS ── */
    const safe = (val) => val || '';

    /* Parse a stored string back into { selected: [...], other: '...' } */
    const parseChipValue = (val, options) => {
      if (!val) return { selected: [], other: '' };
      const parts = val.split(',').map(s => s.trim()).filter(Boolean);
      const optionLabels = options.map(o => o.label);
      const selected = parts.filter(p => optionLabels.includes(p));
      const otherParts = parts.filter(p => !optionLabels.includes(p));
      return { selected, other: otherParts.join(', ') };
    };

    /* Serialize chip selections + other text back to a single string */
    const serializeChipValue = (selected, other) => {
      const all = [...selected];
      if (other.trim()) all.push(other.trim());
      return all.join(', ');
    };

    /* ── CHIP SELECT COMPONENT ── */
    function ChipSelect({ label, options, colorTheme, value, onChange }) {
      const parsed = parseChipValue(value, options);
      const [selected, setSelected] = useState(parsed.selected);
      const [other, setOther] = useState(parsed.other);
      const [showOther, setShowOther] = useState(parsed.other.length > 0);

      const toggle = (optionLabel) => {
        setSelected(prev => {
          const next = prev.includes(optionLabel)
            ? prev.filter(l => l !== optionLabel)
            : [...prev, optionLabel];
          onChange(serializeChipValue(next, other));
          return next;
        });
      };

      const toggleOther = () => {
        if (showOther) {
          setShowOther(false);
          setOther('');
          onChange(serializeChipValue(selected, ''));
        } else {
          setShowOther(true);
        }
      };

      const onOtherChange = (val) => {
        setOther(val);
        onChange(serializeChipValue(selected, val));
      };

      return (
        <div>
          {label && <div className="conv-textarea-label">{label}</div>}
          <div className="chip-grid">
            {options.map(opt => (
              <div
                key={opt.label}
                className={`chip-option color-${opt.color || colorTheme} ${selected.includes(opt.label) ? 'selected' : ''}`}
                onClick={() => toggle(opt.label)}
              >
                <span className="chip-dot"></span>
                {opt.label}
              </div>
            ))}
            <div
              className={`chip-option color-${colorTheme} ${showOther ? 'selected' : ''}`}
              onClick={toggleOther}
              style={showOther ? {} : { color: 'var(--text-muted)' }}
            >
              <span className="chip-dot"></span>
              Other
            </div>
          </div>
          {showOther && (
            <input
              className="chip-other-input"
              type="text"
              placeholder="Please specify..."
              value={other}
              onChange={(e) => onOtherChange(e.target.value)}
              autoFocus
            />
          )}
        </div>
      );
    }

    const MAIN_SITE = 'https://stepwise.education';

    /* ── NAV BAR ── */
    function NavBar() {
      const [mobileOpen, setMobileOpen] = useState(false);
      const links = [
        { label: 'Home', href: MAIN_SITE },
        { label: 'Apply', href: MAIN_SITE + '/apply' },
        { label: 'Find a Facilitator', href: MAIN_SITE + '/facilitators' },
        { label: 'Common Questions', href: MAIN_SITE + '/#faq' },
      ];
      return (
        <nav className="top-nav">
          <div className="nav-left">
            <a className="brand-name" href={MAIN_SITE}>StepWise</a>
            <div className="brand-dots">
              <span className="brand-dot amber"></span>
              <span className="brand-dot red"></span>
              <span className="brand-dot purple"></span>
            </div>
          </div>
          <div className="nav-links">
            {links.map(l => (
              <a key={l.label} className="nav-link" href={l.href}>{l.label}</a>
            ))}
            <a className="nav-link active" href="#">Portal</a>
          </div>
          <button className="nav-mobile-toggle" onClick={() => setMobileOpen(!mobileOpen)}>
            {mobileOpen ? '\u2715' : '\u2630'}
          </button>
          <div className={`nav-mobile-menu ${mobileOpen ? 'open' : ''}`}>
            {links.map(l => (
              <a key={l.label} className="nav-link" href={l.href}>{l.label}</a>
            ))}
            <a className="nav-link active" href="#">Portal</a>
          </div>
        </nav>
      );
    }

    /* ── STEP PROGRESS ── */
    function StepProgress({ current, total }) {
      return (
        <div className="step-progress-wrapper">
          <div className="step-counter">{current} / {total}</div>
          <div className="step-bar">
            {Array.from({ length: total }, (_, i) => (
              <div
                key={i}
                className={`step-segment ${i + 1 === current ? 'active' : i + 1 < current ? 'done' : ''}`}
              ></div>
            ))}
          </div>
        </div>
      );
    }

    /* ── LOGIN VIEW ── */
    function LoginView({ onSendLink }) {
      const [email, setEmail] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!email.trim()) return;
        setLoading(true);
        setError('');
        try {
          const { error: authError } = await supabase.auth.signInWithOtp({
            email: email.trim(),
            options: {
              emailRedirectTo: window.location.origin + window.location.pathname
            }
          });
          if (authError) throw authError;
          onSendLink(email.trim());
        } catch (err) {
          setError(err.message || 'Something went wrong. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div>
          <NavBar />
          <div className="login-card fade-in">
            <div className="gradient-line"></div>
            <h2 className="heading-serif">Participant Portal</h2>
            <p>
              Welcome! Enter the email address you used when applying
              to your StepWise training and we'll send you a secure link.
            </p>
            {error && <div className="alert-banner error">{error}</div>}
            <form onSubmit={handleSubmit}>
              <div className="login-email-row">
                My email is{' '}
                <input
                  className="login-email-input"
                  type="email"
                  placeholder="name@example.com"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  autoFocus
                />
              </div>
              <button
                type="submit"
                className="btn-continue"
                disabled={loading || !email.trim()}
              >
                {loading ? <span className="spinner"></span> : <>Send Magic Link &rsaquo;</>}
              </button>
            </form>
          </div>
        </div>
      );
    }

    /* ── CHECK EMAIL VIEW ── */
    function CheckEmailView({ email, onBack }) {
      return (
        <div>
          <NavBar />
          <div className="login-card fade-in">
            <div className="gradient-line"></div>
            <div className="check-email-icon">&#9993;</div>
            <h2 className="heading-serif">Check Your Inbox</h2>
            <p>
              We sent a magic link to <strong>{email}</strong>.<br />
              Click the link in the email to securely access your profile.
            </p>
            <p style={{fontSize: '13px', color: 'var(--text-muted)', marginBottom: '24px'}}>
              The link expires in 1 hour. Check your spam folder if you don't see it.
            </p>
            <button className="btn-back" onClick={onBack}>
              &lsaquo; Use a different email
            </button>
          </div>
        </div>
      );
    }

    /* ── NOT FOUND VIEW ── */
    function NotFoundView({ email, onSignOut }) {
      return (
        <div>
          <NavBar />
          <div className="login-card fade-in">
            <div className="gradient-line"></div>
            <div className="not-found-icon">&#128269;</div>
            <h2 className="heading-serif">Record Not Found</h2>
            <p>
              We couldn't find a participant record for <strong>{email}</strong>.
              Please make sure you're using the same email you applied with,
              or reach out to StepWise for assistance.
            </p>
            <div style={{marginTop: '8px'}}>
              <a href="mailto:stepwisetraining@proton.me" style={{color: 'var(--brand-amber)', fontWeight: 600, textDecoration: 'none'}}>
                stepwisetraining@proton.me
              </a>
            </div>
            <div style={{marginTop: '24px'}}>
              <button className="btn-back" onClick={onSignOut}>
                &lsaquo; Try a different email
              </button>
            </div>
          </div>
        </div>
      );
    }

    /* ── PROFILE FORM ── */
    function ProfileView({ applicant, training, onSave }) {
      const [step, setStep] = useState(1);
      const totalSteps = 5;
      const [form, setForm] = useState({
        name: safe(applicant.name),
        birth_date: safe(applicant.birth_date),
        phone: safe(applicant.phone),
        dietary_preferences: safe(applicant.dietary_preferences),
        allergies: safe(applicant.allergies),
        physical_health: safe(applicant.physical_health),
        physical_medications: safe(applicant.physical_medications),
        mental_health_dx: safe(applicant.mental_health_dx),
        current_mental_health: safe(applicant.current_mental_health),
        psych_medications: safe(applicant.psych_medications),
        notes: safe(applicant.notes),
      });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const u = (field, value) => setForm(prev => ({ ...prev, [field]: value }));

      const parseBirthDate = () => {
        if (!form.birth_date) return { mm: '', dd: '', yyyy: '' };
        const parts = form.birth_date.split('-');
        return { yyyy: parts[0] || '', mm: parts[1] || '', dd: parts[2] || '' };
      };
      const bd = parseBirthDate();
      const setBirthPart = (part, val) => {
        const cur = parseBirthDate();
        cur[part] = val.replace(/\D/g, '');
        if (cur.yyyy || cur.mm || cur.dd) {
          const y = cur.yyyy.padStart(4, '0').slice(0, 4);
          const m = cur.mm.padStart(2, '0').slice(0, 2);
          const d = cur.dd.padStart(2, '0').slice(0, 2);
          u('birth_date', `${y}-${m}-${d}`);
        } else {
          u('birth_date', '');
        }
      };

      const handleSubmit = async () => {
        setLoading(true);
        setError('');
        try {
          const { error: updateError } = await supabase
            .from('applicants')
            .update(form)
            .eq('id', applicant.id);
          if (updateError) throw updateError;
          onSave();
        } catch (err) {
          setError(err.message);
          setLoading(false);
        }
      };

      const next = () => setStep(s => Math.min(s + 1, totalSteps));
      const back = () => setStep(s => Math.max(s - 1, 1));

      return (
        <div>
          <NavBar />
          <div className="page-container fade-in">
            <div className="page-title">
              <h1 className="heading-serif-italic">Your Profile</h1>
            </div>
            {training && (
              <div style={{textAlign: 'center', marginBottom: '8px'}}>
                <span className="training-badge">
                  <span className="brand-dot amber" style={{width: '8px', height: '8px'}}></span>
                  {training.name}
                </span>
              </div>
            )}

            <StepProgress current={step} total={totalSteps} />

            {error && <div className="alert-banner error">{error}</div>}

            {/* STEP 1: About You */}
            {step === 1 && (
              <div className="form-section fade-in">
                <div className="section-label">ABOUT YOU</div>
                <div className="section-title"><h2 className="heading-serif">The Basics</h2></div>
                <div style={{marginTop: '28px'}}>
                  <div className="conv-line">
                    My name is{' '}
                    <input
                      className="inline-input wide"
                      type="text"
                      placeholder="full name"
                      value={form.name}
                      onChange={(e) => u('name', e.target.value)}
                      autoFocus
                    />.
                  </div>
                  <div className="conv-line">
                    I was born on{' '}
                    <input className="inline-input date-part" placeholder="MM" maxLength="2" value={bd.mm} onChange={(e) => setBirthPart('mm', e.target.value)} />
                    {' / '}
                    <input className="inline-input date-part" placeholder="DD" maxLength="2" value={bd.dd} onChange={(e) => setBirthPart('dd', e.target.value)} />
                    {' / '}
                    <input className="inline-input date-part year" placeholder="YYYY" maxLength="4" value={bd.yyyy} onChange={(e) => setBirthPart('yyyy', e.target.value)} />.
                  </div>
                  <div className="conv-line">
                    You can reach me at{' '}
                    <span className="read-only-value">{applicant.email}</span>.
                  </div>
                  <div className="conv-line">
                    Or call me at{' '}
                    <input
                      className="inline-input"
                      type="tel"
                      placeholder="phone number"
                      value={form.phone}
                      onChange={(e) => u('phone', e.target.value)}
                      style={{minWidth: '160px'}}
                    />.
                  </div>
                </div>
                <div className="btn-nav-row">
                  <button className="btn-continue" onClick={next}>Continue &rsaquo;</button>
                </div>
              </div>
            )}

            {/* STEP 2: Dietary & Allergies */}
            {step === 2 && (
              <div className="form-section fade-in">
                <div className="section-label">NOURISHMENT</div>
                <div className="section-title"><h2 className="heading-serif">Diet & Sensitivities</h2></div>
                <div style={{marginTop: '28px'}}>
                  <ChipSelect
                    label="My dietary preferences or needs are:"
                    colorTheme="amber"
                    options={[
                      { label: 'Vegetarian', color: 'teal' },
                      { label: 'Vegan', color: 'teal' },
                      { label: 'Gluten-free', color: 'amber' },
                      { label: 'Dairy-free', color: 'amber' },
                      { label: 'Halal', color: 'purple' },
                      { label: 'Kosher', color: 'purple' },
                      { label: 'Pescatarian', color: 'teal' },
                      { label: 'No restrictions', color: 'blue' },
                    ]}
                    value={form.dietary_preferences}
                    onChange={(val) => u('dietary_preferences', val)}
                  />
                  <ChipSelect
                    label="I have the following allergies or sensitivities:"
                    colorTheme="red"
                    options={[
                      { label: 'Peanuts', color: 'red' },
                      { label: 'Tree nuts', color: 'red' },
                      { label: 'Shellfish', color: 'rose' },
                      { label: 'Dairy', color: 'amber' },
                      { label: 'Eggs', color: 'amber' },
                      { label: 'Gluten/wheat', color: 'purple' },
                      { label: 'Soy', color: 'teal' },
                      { label: 'No allergies', color: 'blue' },
                    ]}
                    value={form.allergies}
                    onChange={(val) => u('allergies', val)}
                  />
                </div>
                <div className="btn-nav-row">
                  <button className="btn-back" onClick={back}>&lsaquo; Back</button>
                  <button className="btn-continue" onClick={next}>Continue &rsaquo;</button>
                </div>
              </div>
            )}

            {/* STEP 3: Physical Health */}
            {step === 3 && (
              <div className="form-section fade-in">
                <div className="section-label">PHYSICAL WELLBEING</div>
                <div className="section-title"><h2 className="heading-serif">Your Body</h2></div>
                <div style={{marginTop: '28px'}}>
                  <ChipSelect
                    label="Please share anything about your physical health we should know:"
                    colorTheme="red"
                    options={[
                      { label: 'Chronic pain', color: 'red' },
                      { label: 'Back/spine issues', color: 'red' },
                      { label: 'Joint problems', color: 'amber' },
                      { label: 'Mobility limitations', color: 'amber' },
                      { label: 'Heart condition', color: 'rose' },
                      { label: 'Respiratory issues', color: 'purple' },
                      { label: 'Diabetes', color: 'teal' },
                      { label: 'Autoimmune condition', color: 'blue' },
                      { label: 'Recent surgery', color: 'purple' },
                      { label: 'Pregnancy', color: 'rose' },
                      { label: 'No conditions to note', color: 'teal' },
                    ]}
                    value={form.physical_health}
                    onChange={(val) => u('physical_health', val)}
                  />
                  <div className="conv-textarea-label">Medications you currently take for physical health:</div>
                  <textarea
                    className="conv-textarea"
                    placeholder="Include name, dosage, and frequency if possible..."
                    value={form.physical_medications}
                    onChange={(e) => u('physical_medications', e.target.value)}
                  ></textarea>
                </div>
                <div className="btn-nav-row">
                  <button className="btn-back" onClick={back}>&lsaquo; Back</button>
                  <button className="btn-continue" onClick={next}>Continue &rsaquo;</button>
                </div>
              </div>
            )}

            {/* STEP 4: Mental Health */}
            {step === 4 && (
              <div className="form-section fade-in">
                <div className="section-label">MENTAL WELLBEING</div>
                <div className="section-title"><h2 className="heading-serif">Inner Landscape</h2></div>
                <div style={{marginTop: '28px'}}>
                  <ChipSelect
                    label="Any past or current mental health diagnoses:"
                    colorTheme="purple"
                    options={[
                      { label: 'Anxiety', color: 'amber' },
                      { label: 'Depression', color: 'blue' },
                      { label: 'PTSD/trauma', color: 'red' },
                      { label: 'Bipolar', color: 'purple' },
                      { label: 'ADHD', color: 'teal' },
                      { label: 'OCD', color: 'amber' },
                      { label: 'Eating disorder', color: 'rose' },
                      { label: 'Personality disorder', color: 'purple' },
                      { label: 'Substance use', color: 'red' },
                      { label: 'Grief/loss', color: 'blue' },
                      { label: 'None', color: 'teal' },
                    ]}
                    value={form.mental_health_dx}
                    onChange={(val) => u('mental_health_dx', val)}
                  />
                  <ChipSelect
                    label="How would you describe your current mental health?"
                    colorTheme="blue"
                    options={[
                      { label: 'Stable and well', color: 'teal' },
                      { label: 'Mostly good', color: 'teal' },
                      { label: 'Managing day-to-day', color: 'amber' },
                      { label: 'Struggling', color: 'amber' },
                      { label: 'In crisis', color: 'red' },
                      { label: 'In active treatment', color: 'purple' },
                      { label: 'In recovery', color: 'blue' },
                      { label: 'Prefer not to say', color: 'blue' },
                    ]}
                    value={form.current_mental_health}
                    onChange={(val) => u('current_mental_health', val)}
                  />
                  <div className="conv-textarea-label">Psychiatric medications you currently take:</div>
                  <textarea
                    className="conv-textarea"
                    placeholder="Include name, dosage, and frequency if possible..."
                    value={form.psych_medications}
                    onChange={(e) => u('psych_medications', e.target.value)}
                  ></textarea>
                </div>
                <div className="btn-nav-row">
                  <button className="btn-back" onClick={back}>&lsaquo; Back</button>
                  <button className="btn-continue" onClick={next}>Continue &rsaquo;</button>
                </div>
              </div>
            )}

            {/* STEP 5: Review & Submit */}
            {step === 5 && (
              <div className="form-section fade-in">
                <div className="section-label">REVIEW</div>
                <div className="section-title"><h2 className="heading-serif">Almost There</h2></div>
                <p style={{textAlign: 'center', color: 'var(--text-secondary)', fontSize: '14px', marginTop: '4px', marginBottom: '28px'}}>
                  Please review your information below, then submit.
                </p>

                <div className="review-card">
                  <div className="review-label">About You</div>
                  <div className="review-row">
                    <div>
                      <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '2px'}}>Name</div>
                      <div className={`review-value ${!form.name ? 'empty' : ''}`}>{form.name || 'Not provided'}</div>
                    </div>
                    <div>
                      <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '2px'}}>Birth Date</div>
                      <div className={`review-value ${!form.birth_date ? 'empty' : ''}`}>{form.birth_date || 'Not provided'}</div>
                    </div>
                  </div>
                  <div className="review-row" style={{marginTop: '12px'}}>
                    <div>
                      <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '2px'}}>Email</div>
                      <div className="review-value">{applicant.email}</div>
                    </div>
                    <div>
                      <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '2px'}}>Phone</div>
                      <div className={`review-value ${!form.phone ? 'empty' : ''}`}>{form.phone || 'Not provided'}</div>
                    </div>
                  </div>
                </div>

                <div className="review-card">
                  <div className="review-label">Diet & Sensitivities</div>
                  <div style={{marginBottom: '10px'}}>
                    <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '2px'}}>Dietary Preferences</div>
                    <div className={`review-value ${!form.dietary_preferences ? 'empty' : ''}`}>{form.dietary_preferences || 'None noted'}</div>
                  </div>
                  <div>
                    <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '2px'}}>Allergies</div>
                    <div className={`review-value ${!form.allergies ? 'empty' : ''}`}>{form.allergies || 'None noted'}</div>
                  </div>
                </div>

                <div className="review-card">
                  <div className="review-label">Physical Health</div>
                  <div style={{marginBottom: '10px'}}>
                    <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '2px'}}>Physical Health</div>
                    <div className={`review-value ${!form.physical_health ? 'empty' : ''}`}>{form.physical_health || 'None noted'}</div>
                  </div>
                  <div>
                    <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '2px'}}>Medications</div>
                    <div className={`review-value ${!form.physical_medications ? 'empty' : ''}`}>{form.physical_medications || 'None noted'}</div>
                  </div>
                </div>

                <div className="review-card">
                  <div className="review-label">Mental Health</div>
                  <div style={{marginBottom: '10px'}}>
                    <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '2px'}}>Diagnoses</div>
                    <div className={`review-value ${!form.mental_health_dx ? 'empty' : ''}`}>{form.mental_health_dx || 'None noted'}</div>
                  </div>
                  <div style={{marginBottom: '10px'}}>
                    <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '2px'}}>Current Mental Health</div>
                    <div className={`review-value ${!form.current_mental_health ? 'empty' : ''}`}>{form.current_mental_health || 'None noted'}</div>
                  </div>
                  <div>
                    <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '2px'}}>Psychiatric Medications</div>
                    <div className={`review-value ${!form.psych_medications ? 'empty' : ''}`}>{form.psych_medications || 'None noted'}</div>
                  </div>
                </div>

                <div className="btn-nav-row" style={{marginTop: '36px'}}>
                  <button className="btn-back" onClick={back}>&lsaquo; Back</button>
                  <button className="btn-primary-fill" onClick={handleSubmit} disabled={loading}>
                    {loading ? <span className="spinner white"></span> : <>Submit Updates</>}
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    /* ── SUCCESS VIEW ── */
    function SuccessView({ onReturn, onSignOut }) {
      return (
        <div>
          <NavBar />
          <div className="login-card fade-in">
            <div className="gradient-line"></div>
            <div className="success-icon">&#10003;</div>
            <h2 className="heading-serif">All Updated</h2>
            <p>
              Your information has been saved. You'll receive a confirmation
              email at your address shortly.
            </p>
            <p style={{fontSize: '13px', color: 'var(--text-muted)', marginBottom: '28px'}}>
              If anything changes before your training, you can always come back
              and update your profile.
            </p>
            <div style={{display: 'flex', gap: '12px', justifyContent: 'center'}}>
              <button className="btn-continue" onClick={onReturn}>
                Edit Again
              </button>
              <button className="btn-back" onClick={onSignOut}>
                Sign Out
              </button>
            </div>
          </div>
        </div>
      );
    }

    /* ── LOADING VIEW ── */
    function LoadingView() {
      return (
        <div>
          <NavBar />
          <div style={{textAlign: 'center', marginTop: '120px'}}>
            <div className="spinner" style={{width: '28px', height: '28px'}}></div>
            <p style={{marginTop: '16px', color: 'var(--text-secondary)', fontSize: '14px'}}>Loading your profile...</p>
          </div>
        </div>
      );
    }

    /* ── MAIN APP ── */
    function App() {
      const [view, setView] = useState('loading');
      const [session, setSession] = useState(null);
      const [applicant, setApplicant] = useState(null);
      const [training, setTraining] = useState(null);
      const [pendingEmail, setPendingEmail] = useState('');

      useEffect(() => {
        /* Check for existing session */
        supabase.auth.getSession().then(({ data: { session: s } }) => {
          if (s) {
            setSession(s);
            loadApplicant(s.user.email);
          } else {
            setView('login');
          }
        });

        /* Listen for auth changes (magic link callback) */
        const { data: { subscription } } = supabase.auth.onAuthStateChange((event, s) => {
          if (event === 'SIGNED_IN' && s) {
            setSession(s);
            loadApplicant(s.user.email);
          }
          if (event === 'SIGNED_OUT') {
            setSession(null);
            setApplicant(null);
            setTraining(null);
            setView('login');
          }
        });

        return () => subscription.unsubscribe();
      }, []);

      const loadApplicant = async (email) => {
        setView('loading');
        try {
          const { data, error } = await supabase
            .from('applicants')
            .select('*')
            .eq('email', email)
            .limit(1)
            .single();

          if (error || !data) {
            setView('not-found');
            return;
          }

          setApplicant(data);

          /* Load training info */
          if (data.training_id) {
            const { data: t } = await supabase
              .from('trainings')
              .select('*')
              .eq('id', data.training_id)
              .single();
            if (t) setTraining(t);
          }

          setView('profile');
        } catch (err) {
          setView('not-found');
        }
      };

      const handleSendLink = (email) => {
        setPendingEmail(email);
        setView('check-email');
      };

      const handleSignOut = async () => {
        await supabase.auth.signOut();
        setView('login');
      };

      const handleSaveSuccess = () => {
        setView('success');
      };

      const handleReturnToProfile = () => {
        if (session) {
          loadApplicant(session.user.email);
        }
      };

      return (
        <div>
          {view === 'loading' && <LoadingView />}
          {view === 'login' && <LoginView onSendLink={handleSendLink} />}
          {view === 'check-email' && (
            <CheckEmailView
              email={pendingEmail}
              onBack={() => setView('login')}
            />
          )}
          {view === 'not-found' && (
            <NotFoundView
              email={session?.user?.email || ''}
              onSignOut={handleSignOut}
            />
          )}
          {view === 'profile' && applicant && (
            <ProfileView
              applicant={applicant}
              training={training}
              onSave={handleSaveSuccess}
            />
          )}
          {view === 'success' && (
            <SuccessView
              onReturn={handleReturnToProfile}
              onSignOut={handleSignOut}
            />
          )}
          {session && view !== 'login' && view !== 'check-email' && view !== 'loading' && (
            <button className="signout-link" onClick={handleSignOut}>
              Sign out
            </button>
          )}
        </div>
      );
    }

    /* Render */
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
