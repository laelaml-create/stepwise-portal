<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StepWise ‚Äî Admin Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß≠</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
/* ===== Glassmorphism Design System ===== */
:root {
    --bg-gradient-start: #0f0c29;
    --bg-gradient-mid: #302b63;
    --bg-gradient-end: #24243e;
    --glass-bg: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
    --text-primary: #f8fafc;
    --text-secondary: #94a3b8;
    --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --accent-purple: #8b5cf6;
    --accent-blue: #667eea;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-mid), var(--bg-gradient-end));
    min-height: 100vh;
    color: var(--text-primary);
    overflow-x: hidden;
}

body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(168, 85, 247, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(56, 189, 248, 0.15) 0%, transparent 40%);
    pointer-events: none;
    z-index: -1;
}

/* ===== Layout ===== */
.app-container { max-width: 1600px; margin: 0 auto; padding: 1rem; }

.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    background: var(--glass-bg);
    backdrop-filter: blur(16px);
    border: 1px solid var(--glass-border);
    border-radius: 1rem;
}

.header-brand {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.header-brand h1 {
    font-size: 1.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea, #a855f7);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.header-brand .subtitle {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 400;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* ===== Glass Components ===== */
.glass-card {
    position: relative;
    overflow: hidden;
    border-radius: 1rem;
    padding: 1.5rem;
    background: var(--glass-bg);
    backdrop-filter: blur(16px);
    border: 1px solid var(--glass-border);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    animation: fadeIn 0.5s ease-out;
}

.glass-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    pointer-events: none;
}

.glass-btn {
    padding: 0.6rem 1.25rem;
    border-radius: 0.75rem;
    font-weight: 600;
    font-size: 0.85rem;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    cursor: pointer;
    font-family: inherit;
}

.glass-btn:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
    transform: translateY(-2px);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.glass-btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
}

.glass-btn-primary:hover {
    background: linear-gradient(135deg, #7c8ff4, #8a5db5);
    box-shadow: 0 10px 40px rgba(118, 75, 162, 0.4);
}

.glass-btn-sm {
    padding: 0.4rem 0.85rem;
    font-size: 0.75rem;
    border-radius: 0.5rem;
}

.glass-btn-success {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.4), rgba(5, 150, 105, 0.3));
    border: 1px solid rgba(16, 185, 129, 0.4);
}

.glass-btn-danger {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.2));
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.glass-input {
    width: 100%;
    padding: 0.6rem 1rem;
    border-radius: 0.75rem;
    outline: none;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    font-family: inherit;
    font-size: 0.85rem;
}

.glass-input:focus {
    border-color: rgba(102, 126, 234, 0.5);
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
}

.glass-input::placeholder { color: rgba(255, 255, 255, 0.4); }

select.glass-input {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    padding-right: 2rem;
}

select.glass-input option { background: #1e1b4b; color: white; }

/* ===== KPI Grid ===== */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.kpi-card {
    position: relative;
    padding: 1.25rem;
    border-radius: 1rem;
    background: var(--glass-bg);
    backdrop-filter: blur(16px);
    border: 1px solid var(--glass-border);
    animation: fadeIn 0.5s ease-out;
    overflow: hidden;
}

.kpi-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
    pointer-events: none;
}

.kpi-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
.kpi-value { font-size: 2rem; font-weight: 800; line-height: 1.2; }
.kpi-sub { font-size: 0.75rem; color: #6ee7b7; margin-top: 0.25rem; }
.kpi-icon {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    font-size: 1.2rem;
}

/* ===== Tabs ===== */
.tab-bar {
    display: flex;
    gap: 0.25rem;
    margin-bottom: 1.5rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 0.75rem;
    padding: 0.25rem;
    border: 1px solid var(--glass-border);
}

.tab-btn {
    flex: 1;
    padding: 0.6rem 1rem;
    border: none;
    border-radius: 0.5rem;
    background: transparent;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s;
    font-family: inherit;
}

.tab-btn.active {
    background: var(--accent-gradient);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.tab-btn:hover:not(.active) { color: white; background: rgba(255, 255, 255, 0.05); }

.tab-content { display: none; }
.tab-content.active { display: block; }

/* ===== Pipeline Kanban ===== */
.pipeline-container {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 1rem;
    scroll-behavior: smooth;
}

.pipeline-column {
    flex-shrink: 0;
    width: 260px;
    min-height: 300px;
}

.pipeline-col-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 0.75rem;
    margin-bottom: 0.75rem;
    border-bottom: 2px solid;
}

.pipeline-col-header h3 { font-size: 0.9rem; font-weight: 700; }

.pipeline-col-count {
    padding: 0.15rem 0.6rem;
    border-radius: 9999px;
    background: rgba(255, 255, 255, 0.1);
    font-size: 0.75rem;
    font-weight: 600;
}

.pipeline-cards { display: flex; flex-direction: column; gap: 0.6rem; }

.participant-card {
    padding: 0.85rem;
    border-radius: 0.75rem;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.08);
    cursor: pointer;
    transition: all 0.3s;
}

.participant-card:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.participant-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.2rem; }
.participant-email { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.4rem; }
.participant-meta { font-size: 0.7rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.4rem; }

/* Pipeline column border colors */
.col-lead { border-color: #64748b; }
.col-initial_call { border-color: #3b82f6; }
.col-application { border-color: #f59e0b; }
.col-interview { border-color: #a855f7; }
.col-approved { border-color: #10b981; }
.col-paid { border-color: #22d3ee; }
.col-confirmed { border-color: #22c55e; }

/* ===== Table View ===== */
.table-wrapper { overflow-x: auto; }

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

thead th {
    text-align: left;
    padding: 0.75rem 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--glass-border);
    white-space: nowrap;
}

tbody td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    vertical-align: middle;
}

tbody tr { transition: background 0.2s; cursor: pointer; }
tbody tr:hover { background: rgba(255, 255, 255, 0.04); }

/* Status Badges */
.status-badge {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: capitalize;
    letter-spacing: 0.02em;
}

.badge-lead { background: rgba(100, 116, 139, 0.3); color: #cbd5e1; }
.badge-initial_call, .badge-call { background: rgba(59, 130, 246, 0.3); color: #93c5fd; }
.badge-application, .badge-submitted, .badge-received { background: rgba(245, 158, 11, 0.3); color: #fcd34d; }
.badge-under_review { background: rgba(251, 191, 36, 0.3); color: #fde68a; }
.badge-interview, .badge-interview_scheduled, .badge-interview_complete { background: rgba(168, 85, 247, 0.3); color: #c4b5fd; }
.badge-approved, .badge-accepted { background: rgba(16, 185, 129, 0.3); color: #6ee7b7; }
.badge-paid, .badge-paid_in_full, .badge-deposit_paid { background: rgba(34, 211, 238, 0.3); color: #67e8f9; }
.badge-confirmed, .badge-complete { background: rgba(34, 197, 94, 0.3); color: #86efac; }
.badge-waitlisted { background: rgba(251, 146, 60, 0.3); color: #fdba74; }
.badge-declined, .badge-withdrawn, .badge-cancelled { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }
.badge-pending { background: rgba(148, 163, 184, 0.3); color: #cbd5e1; }

/* ===== Modal ===== */
.modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 100;
    opacity: 0;
    transition: opacity 0.3s;
    display: none;
}

.modal-backdrop.open { display: flex; align-items: center; justify-content: center; opacity: 1; }

.modal {
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    background: linear-gradient(135deg, rgba(30, 27, 75, 0.98), rgba(45, 40, 95, 0.98));
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1.5rem;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 60px rgba(102, 126, 234, 0.15);
    transform: scale(0.95);
    transition: transform 0.3s;
}

.modal-backdrop.open .modal { transform: scale(1); }

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header-info { display: flex; align-items: center; gap: 1rem; }

.modal-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #a855f7);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    font-weight: 700;
}

.modal-name { font-size: 1.2rem; font-weight: 700; }
.modal-email { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.15rem; }

.modal-close {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    border: none;
    background: rgba(255, 255, 255, 0.05);
    color: white;
    cursor: pointer;
    font-size: 1.1rem;
    transition: background 0.2s;
}

.modal-close:hover { background: rgba(255, 255, 255, 0.1); }

.modal-body { padding: 1.5rem; }

.modal-section {
    margin-bottom: 1.5rem;
}

.modal-section h3 {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
}

.detail-item label {
    display: block;
    font-size: 0.7rem;
    text-transform: uppercase;
    color: var(--text-secondary);
    letter-spacing: 0.05em;
    margin-bottom: 0.2rem;
}

.detail-item span {
    font-size: 0.85rem;
    color: var(--text-primary);
}

/* Journey stages in modal */
.journey-stages { display: flex; flex-direction: column; gap: 0; }

.journey-stage {
    display: flex;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.04);
    border-left: 3px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
}

.journey-stage.stage-completed {
    border-left-color: rgba(16, 185, 129, 0.5);
}

.journey-stage.stage-current {
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-left: 3px solid rgba(139, 92, 246, 0.8);
    box-shadow: 0 0 25px rgba(139, 92, 246, 0.1);
}

.journey-stage.stage-upcoming { opacity: 0.45; }

.stage-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.stage-icon.completed { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
.stage-icon.current { background: rgba(139, 92, 246, 0.2); color: #c4b5fd; }
.stage-icon.upcoming { background: rgba(255, 255, 255, 0.05); color: #64748b; }

.stage-name { font-weight: 600; font-size: 0.85rem; }
.stage-desc { font-size: 0.75rem; color: var(--text-secondary); }

.stage-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.5rem;
}

.journey-connector {
    margin-left: 1.5rem;
    border-left: 2px dashed rgba(255, 255, 255, 0.1);
    height: 1.25rem;
}

.modal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(0, 0, 0, 0.15);
}

.modal-footer-left { display: flex; gap: 0.5rem; }
.modal-footer-right { display: flex; gap: 0.5rem; }

/* ===== Loading ===== */
.loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4rem;
    color: var(--text-secondary);
    gap: 0.75rem;
}

.spinner {
    width: 24px;
    height: 24px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top-color: var(--accent-purple);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* ===== Notification Toast ===== */
.toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 200;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.toast {
    padding: 0.75rem 1.25rem;
    border-radius: 0.75rem;
    background: rgba(30, 27, 75, 0.95);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 0.85rem;
    animation: slideIn 0.3s ease-out;
    max-width: 350px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
}

.toast.success { border-left: 3px solid #10b981; }
.toast.error { border-left: 3px solid #ef4444; }
.toast.info { border-left: 3px solid #3b82f6; }

@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* ===== Empty State ===== */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-secondary);
}

.empty-state .emoji { font-size: 2.5rem; margin-bottom: 0.75rem; }
.empty-state p { font-size: 0.9rem; }

/* ===== Responsive ===== */
@media (max-width: 768px) {
    .header { flex-direction: column; gap: 0.75rem; }
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .pipeline-column { width: 220px; }
    .detail-grid { grid-template-columns: 1fr; }
    .modal { width: 95%; }
    .modal-footer { flex-direction: column; }
    .modal-footer-left, .modal-footer-right { width: 100%; }
}

/* ===== Scrollbar ===== */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.03); border-radius: 10px; }
::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }

/* ===== Search highlight ===== */
.search-bar { position: relative; }
.search-bar input { padding-left: 2.25rem; }
.search-icon {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    font-size: 0.85rem;
}

/* ===== Protonmail Section ===== */
.email-compose {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 0.75rem;
    padding: 1rem;
}

.email-compose textarea {
    width: 100%;
    min-height: 100px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 0.5rem;
    color: white;
    padding: 0.75rem;
    font-family: inherit;
    font-size: 0.85rem;
    resize: vertical;
    outline: none;
}

.email-compose textarea:focus {
    border-color: rgba(102, 126, 234, 0.4);
}

/* Notes section */
.notes-area {
    width: 100%;
    min-height: 80px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 0.5rem;
    color: white;
    padding: 0.75rem;
    font-family: inherit;
    font-size: 0.85rem;
    resize: vertical;
    outline: none;
}

.notes-area:focus { border-color: rgba(102, 126, 234, 0.4); }

/* Source indicator */
.source-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.15rem 0.5rem;
    border-radius: 0.3rem;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
}

.source-jotform { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
.source-website { background: rgba(102, 126, 234, 0.2); color: #93c5fd; }
.source-manual { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; }
    </style>
</head>
<body>
    <div class="app-container" id="app">
        <!-- Header -->
        <header class="header">
            <div class="header-brand">
                <div>
                    <h1>StepWise</h1>
                    <div class="subtitle">Operations Dashboard</div>
                </div>
            </div>
            <div class="header-actions">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="glass-input" id="searchInput" placeholder="Search participants..." style="width: 250px; padding-left: 2.25rem;">
                </div>
                <select class="glass-input" id="trainingFilter" style="width: auto;">
                    <option value="all">All Trainings</option>
                </select>
                <button class="glass-btn glass-btn-primary" onclick="refreshData()">‚Üª Refresh</button>
            </div>
        </header>

        <!-- KPI Grid -->
        <div class="kpi-grid" id="kpiGrid">
            <div class="kpi-card">
                <div class="kpi-label">Total Applicants</div>
                <div class="kpi-value" id="kpiTotal">‚Äî</div>
                <div class="kpi-sub" id="kpiTotalSub">Loading...</div>
                <div class="kpi-icon">üë•</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Active Pipeline</div>
                <div class="kpi-value" id="kpiActive">‚Äî</div>
                <div class="kpi-sub" id="kpiActiveSub">In progress</div>
                <div class="kpi-icon">üìä</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Confirmed</div>
                <div class="kpi-value" id="kpiConfirmed">‚Äî</div>
                <div class="kpi-sub" id="kpiConfirmedSub">Ready</div>
                <div class="kpi-icon">‚úÖ</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Paid</div>
                <div class="kpi-value" id="kpiPaid">‚Äî</div>
                <div class="kpi-sub" id="kpiPaidSub">Revenue collected</div>
                <div class="kpi-icon">üí≥</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">New This Week</div>
                <div class="kpi-value" id="kpiNew">‚Äî</div>
                <div class="kpi-sub" id="kpiNewSub">Last 7 days</div>
                <div class="kpi-icon">üÜï</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="pipeline" onclick="switchTab('pipeline')">Pipeline Board</button>
            <button class="tab-btn" data-tab="table" onclick="switchTab('table')">Table View</button>
            <button class="tab-btn" data-tab="applications" onclick="switchTab('applications')">Full Applications</button>
        </div>

        <!-- Pipeline View -->
        <div class="tab-content active" id="tab-pipeline">
            <div class="glass-card">
                <div class="pipeline-container" id="pipelineContainer">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <span>Loading pipeline...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table View -->
        <div class="tab-content" id="tab-table">
            <div class="glass-card">
                <div class="table-wrapper" id="tableContainer">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <span>Loading data...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Full Applications View -->
        <div class="tab-content" id="tab-applications">
            <div class="glass-card">
                <div id="applicationsContainer">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <span>Loading applications...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Participant Detail Modal -->
    <div class="modal-backdrop" id="modalBackdrop" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header" id="modalHeader"></div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
// ===== Configuration =====
const SUPABASE_URL = 'https://ybludwecmqghoheotzzz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlibHVkd2VjbXFnaG9oZW90enp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MzI4MzMsImV4cCI6MjA4NjAwODgzM30._wND5hmDkd4sh7clXaBPZP0lU-c6Traz0KzlYyPxKWk';
const PROTON_EMAIL = 'stepwisetraining@proton.me';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ===== Pipeline Stage Definitions =====
const PIPELINE_STAGES = [
    { id: 'lead', name: 'Leads', icon: 'üë§', color: '#64748b', borderClass: 'col-lead' },
    { id: 'initial_call', name: 'Initial Call', icon: 'üìû', color: '#3b82f6', borderClass: 'col-initial_call' },
    { id: 'application', name: 'Application', icon: 'üìã', color: '#f59e0b', borderClass: 'col-application' },
    { id: 'interview', name: 'Interview', icon: 'üéôÔ∏è', color: '#a855f7', borderClass: 'col-interview' },
    { id: 'approved', name: 'Approved', icon: '‚úÖ', color: '#10b981', borderClass: 'col-approved' },
    { id: 'paid', name: 'Paid', icon: 'üí≥', color: '#22d3ee', borderClass: 'col-paid' },
    { id: 'confirmed', name: 'Confirmed', icon: 'üéâ', color: '#22c55e', borderClass: 'col-confirmed' },
];

const STAGE_ORDER = PIPELINE_STAGES.map(s => s.id);

// Journey stage actions
const STAGE_ACTIONS = {
    lead: [{ id: 'mark_contacted', label: 'Mark Contacted', primary: true }],
    initial_call: [
        { id: 'schedule_call', label: 'Schedule Call' },
        { id: 'complete_call', label: 'Mark Complete', primary: true }
    ],
    application: [
        { id: 'view_application', label: 'View Application' },
        { id: 'complete_review', label: 'Complete Review', primary: true }
    ],
    interview: [
        { id: 'schedule_interview', label: 'Schedule Interview' },
        { id: 'complete_interview', label: 'Complete', primary: true }
    ],
    approved: [{ id: 'approve', label: 'Confirm Approval', primary: true }],
    paid: [
        { id: 'send_stripe_link', label: 'Send Stripe Link', primary: true },
        { id: 'mark_paid', label: 'Mark as Paid' }
    ],
    confirmed: [{ id: 'send_course_link', label: 'Send Course Link', primary: true }],
};

// ===== State =====
let allApplicants = [];      // from applicants table
let allApplications = [];    // from applications table
let mergedParticipants = [];  // combined & normalized
let trainings = [];
let currentFilter = 'all';
let searchQuery = '';

// ===== Status Mapping =====
// Map various status strings to pipeline stages
function mapToPipelineStage(participant) {
    const appStatus = (participant.app_status || '').toLowerCase().replace(/\s+/g, '_');
    const acceptance = (participant.acceptance || '').toLowerCase();
    const paymentStatus = (participant.payment_status || '').toLowerCase().replace(/\s+/g, '_');
    const regStatus = (participant.registration_status || '').toLowerCase();
    const formStatus = (participant.form_status || '').toLowerCase();

    // Check payment/registration first (most advanced)
    if (regStatus === 'complete' || regStatus === 'confirmed') return 'confirmed';
    if (paymentStatus === 'paid_in_full' || paymentStatus === 'paid') return 'paid';
    if (paymentStatus === 'deposit_paid') return 'paid';

    // Check acceptance
    if (acceptance === 'accepted' || appStatus === 'accepted') return 'approved';

    // Check interview stages
    if (appStatus === 'interview_complete') return 'approved';
    if (appStatus === 'interview_scheduled' || appStatus === 'interview') return 'interview';

    // Check application stages
    if (appStatus === 'under_review') return 'application';
    if (appStatus === 'received' || formStatus === 'submitted') return 'application';

    // For applications table entries with a status
    if (formStatus === 'submitted' || formStatus === 'received') return 'application';

    // Default: if they have an application record but no explicit status
    if (participant._source === 'applications') return 'application';

    return 'lead';
}

// ===== Data Loading =====
async function loadTrainings() {
    const { data, error } = await sb
        .from('trainings')
        .select('id, name, start_date, end_date, location, status, price')
        .order('start_date', { ascending: false });

    if (error) {
        console.error('Error loading trainings:', error);
        return;
    }

    trainings = data || [];
    const select = document.getElementById('trainingFilter');
    select.innerHTML = '<option value="all">All Trainings</option>';
    trainings.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name || `Training ${t.id.slice(0, 8)}`;
        select.appendChild(opt);
    });
}

async function loadApplicants() {
    const { data, error } = await sb
        .from('applicants')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error loading applicants:', error);
        return [];
    }
    return (data || []).map(a => ({
        ...a,
        _source: 'applicants',
        _source_label: 'Admin',
        first_name: a.name ? a.name.split(' ')[0] : '',
        last_name: a.name ? a.name.split(' ').slice(1).join(' ') : '',
        full_name: a.name || 'Unknown',
    }));
}

async function loadApplications() {
    const { data, error } = await sb
        .from('applications')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error loading applications:', error);
        return [];
    }
    return (data || []).map(a => ({
        ...a,
        _source: 'applications',
        _source_label: a.created_at && new Date(a.created_at) > new Date('2025-01-01') ? 'Website' : 'JotForm',
        full_name: [a.first_name, a.last_name].filter(Boolean).join(' ') || 'Unknown',
        form_status: a.status || '',
    }));
}

// Merge applicants + applications by email, keeping the richest record
function mergeParticipants(applicants, applications) {
    const byEmail = {};

    // First, add all applicants
    applicants.forEach(a => {
        const email = (a.email || '').toLowerCase();
        if (email) byEmail[email] = { ...a };
    });

    // Then, merge applications (richer data wins)
    applications.forEach(a => {
        const email = (a.email || '').toLowerCase();
        if (!email) return;

        if (byEmail[email]) {
            // Merge: keep applicants admin fields, add applications detail fields
            byEmail[email] = {
                ...byEmail[email],
                ...a,
                // Preserve admin statuses if they exist
                app_status: byEmail[email].app_status || a.status || '',
                acceptance: byEmail[email].acceptance || '',
                payment_status: byEmail[email].payment_status || '',
                registration_status: byEmail[email].registration_status || '',
                admin_notes: byEmail[email].notes || a.admin_notes || '',
                training_id: byEmail[email].training_id || a.retreat_id || '',
                _source: 'merged',
                _source_label: 'Both',
                full_name: byEmail[email].full_name || a.full_name,
            };
        } else {
            byEmail[email] = { ...a };
        }
    });

    const result = Object.values(byEmail);

    // Assign pipeline stage
    result.forEach(p => {
        p.pipeline_stage = mapToPipelineStage(p);
    });

    return result;
}

async function refreshData() {
    showToast('Refreshing data...', 'info');

    try {
        await loadTrainings();
        const [applicants, applications] = await Promise.all([
            loadApplicants(),
            loadApplications()
        ]);

        allApplicants = applicants;
        allApplications = applications;
        mergedParticipants = mergeParticipants(applicants, applications);

        applyFilters();
        showToast(`Loaded ${mergedParticipants.length} participants`, 'success');
    } catch (err) {
        console.error('Error refreshing data:', err);
        showToast('Error loading data', 'error');
    }
}

// ===== Filtering =====
function applyFilters() {
    let filtered = [...mergedParticipants];

    // Training filter
    if (currentFilter !== 'all') {
        filtered = filtered.filter(p =>
            p.training_id === currentFilter || p.retreat_id === currentFilter
        );
    }

    // Search filter
    if (searchQuery) {
        const q = searchQuery.toLowerCase();
        filtered = filtered.filter(p =>
            (p.full_name || '').toLowerCase().includes(q) ||
            (p.email || '').toLowerCase().includes(q) ||
            (p.phone || '').toLowerCase().includes(q)
        );
    }

    renderKPIs(filtered);
    renderPipeline(filtered);
    renderTable(filtered);
    renderApplications(filtered);
}

// ===== Rendering: KPIs =====
function renderKPIs(participants) {
    const total = participants.length;
    const active = participants.filter(p => !['confirmed', 'lead'].includes(p.pipeline_stage)).length;
    const confirmed = participants.filter(p => p.pipeline_stage === 'confirmed').length;
    const paid = participants.filter(p => ['paid', 'confirmed'].includes(p.pipeline_stage)).length;

    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    const newThisWeek = participants.filter(p => p.created_at && new Date(p.created_at) > oneWeekAgo).length;

    document.getElementById('kpiTotal').textContent = total;
    document.getElementById('kpiTotalSub').textContent = `Across ${trainings.length} trainings`;
    document.getElementById('kpiActive').textContent = active;
    document.getElementById('kpiActiveSub').textContent = `In pipeline`;
    document.getElementById('kpiConfirmed').textContent = confirmed;
    document.getElementById('kpiConfirmedSub').textContent = 'Fully confirmed';
    document.getElementById('kpiPaid').textContent = paid;
    document.getElementById('kpiPaidSub').textContent = 'Payment received';
    document.getElementById('kpiNew').textContent = newThisWeek;
    document.getElementById('kpiNewSub').textContent = 'Last 7 days';
}

// ===== Rendering: Pipeline =====
function renderPipeline(participants) {
    const container = document.getElementById('pipelineContainer');

    const html = PIPELINE_STAGES.map(stage => {
        const stageParticipants = participants.filter(p => p.pipeline_stage === stage.id);
        const cards = stageParticipants.map(p => `
            <div class="participant-card" onclick="openModal('${p.email}')">
                <div class="participant-name">${escapeHtml(p.full_name)}</div>
                <div class="participant-email">${escapeHtml(p.email || '')}</div>
                <div class="participant-meta">
                    ${p._source_label ? `<span class="source-tag ${p._source_label === 'JotForm' ? 'source-jotform' : p._source_label === 'Website' ? 'source-website' : 'source-manual'}">${p._source_label}</span>` : ''}
                    ${p.created_at ? `<span>üìÖ ${new Date(p.created_at).toLocaleDateString()}</span>` : ''}
                </div>
            </div>
        `).join('');

        return `
            <div class="pipeline-column">
                <div class="pipeline-col-header ${stage.borderClass}">
                    <h3>${stage.icon} ${stage.name}</h3>
                    <span class="pipeline-col-count">${stageParticipants.length}</span>
                </div>
                <div class="pipeline-cards">
                    ${cards || `<div class="empty-state" style="padding: 1rem;"><p style="font-size: 0.75rem; opacity: 0.5;">No participants</p></div>`}
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

// ===== Rendering: Table =====
function renderTable(participants) {
    const container = document.getElementById('tableContainer');

    if (participants.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="emoji">üìã</div><p>No participants found</p></div>`;
        return;
    }

    const rows = participants.map(p => {
        const stage = PIPELINE_STAGES.find(s => s.id === p.pipeline_stage) || PIPELINE_STAGES[0];
        const sourceClass = p._source_label === 'JotForm' ? 'source-jotform' : p._source_label === 'Website' ? 'source-website' : 'source-manual';
        return `
            <tr onclick="openModal('${escapeHtml(p.email)}')">
                <td><strong>${escapeHtml(p.full_name)}</strong></td>
                <td>${escapeHtml(p.email || '')}</td>
                <td>${escapeHtml(p.phone || '‚Äî')}</td>
                <td><span class="status-badge badge-${p.pipeline_stage}">${stage.icon} ${stage.name}</span></td>
                <td>${p.app_status ? `<span class="status-badge badge-${(p.app_status || '').toLowerCase().replace(/\s+/g, '_')}">${escapeHtml(p.app_status)}</span>` : '‚Äî'}</td>
                <td><span class="source-tag ${sourceClass}">${p._source_label || '‚Äî'}</span></td>
                <td>${p.created_at ? new Date(p.created_at).toLocaleDateString() : '‚Äî'}</td>
                <td>
                    <button class="glass-btn glass-btn-sm" onclick="event.stopPropagation(); emailParticipant('${escapeHtml(p.email)}', '${escapeHtml(p.full_name)}')">‚úâÔ∏è</button>
                </td>
            </tr>
        `;
    }).join('');

    container.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Pipeline Stage</th>
                    <th>App Status</th>
                    <th>Source</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
}

// ===== Rendering: Full Applications =====
function renderApplications(participants) {
    const container = document.getElementById('applicationsContainer');
    const apps = participants.filter(p => p._source === 'applications' || p._source === 'merged');

    if (apps.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="emoji">üìù</div><p>No full applications found.<br>New applications will appear here from <strong>stepwise.education/apply</strong></p></div>`;
        return;
    }

    const rows = apps.map(p => `
        <tr onclick="openModal('${escapeHtml(p.email)}')">
            <td><strong>${escapeHtml(p.full_name)}</strong></td>
            <td>${escapeHtml(p.email || '')}</td>
            <td>${p.journey_work_experience ? '‚úÖ' : '‚Äî'}</td>
            <td>${p.medicine_experience ? '‚úÖ' : '‚Äî'}</td>
            <td>${p.physical_health_issues ? '‚úÖ' : '‚Äî'}</td>
            <td>${p.mental_health_issues || p.dsm_diagnosis ? '‚úÖ' : '‚Äî'}</td>
            <td><span class="status-badge badge-${(p.form_status || p.status || 'pending').toLowerCase()}">${escapeHtml(p.form_status || p.status || 'Submitted')}</span></td>
            <td>${p.created_at ? new Date(p.created_at).toLocaleDateString() : '‚Äî'}</td>
        </tr>
    `).join('');

    container.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Journey</th>
                    <th>Medicine Exp</th>
                    <th>Physical Health</th>
                    <th>Mental Health</th>
                    <th>Status</th>
                    <th>Submitted</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
}

// ===== Modal =====
function openModal(email) {
    const p = mergedParticipants.find(x => x.email === email);
    if (!p) return;

    const initials = (p.full_name || '??').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();

    // Header
    document.getElementById('modalHeader').innerHTML = `
        <div class="modal-header-info">
            <div class="modal-avatar">${initials}</div>
            <div>
                <div class="modal-name">${escapeHtml(p.full_name)}</div>
                <div class="modal-email">
                    ${escapeHtml(p.email || '')}
                    ${p.phone ? ` ¬∑ ${escapeHtml(p.phone)}` : ''}
                    ${p.signal_handle ? ` ¬∑ Signal: ${escapeHtml(p.signal_handle)}` : ''}
                </div>
            </div>
        </div>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
    `;

    // Body
    let bodyHtml = '';

    // Pipeline Journey
    bodyHtml += `<div class="modal-section"><h3>üìç Pipeline Journey</h3><div class="journey-stages">`;
    const currentIdx = STAGE_ORDER.indexOf(p.pipeline_stage);
    PIPELINE_STAGES.forEach((stage, idx) => {
        let stateClass = 'stage-upcoming';
        let iconClass = 'upcoming';
        let iconSymbol = '‚óã';
        if (idx < currentIdx) { stateClass = 'stage-completed'; iconClass = 'completed'; iconSymbol = '‚úì'; }
        else if (idx === currentIdx) { stateClass = 'stage-current'; iconClass = 'current'; iconSymbol = '‚óâ'; }

        const actions = (idx === currentIdx) ? (STAGE_ACTIONS[stage.id] || []) : [];
        const actionButtons = actions.map(a =>
            `<button class="glass-btn glass-btn-sm ${a.primary ? 'glass-btn-primary' : ''}" onclick="handleStageAction('${p.email}', '${a.id}')">${a.label}</button>`
        ).join('');

        bodyHtml += `
            <div class="journey-stage ${stateClass}">
                <div class="stage-icon ${iconClass}">${iconSymbol}</div>
                <div>
                    <div class="stage-name">${stage.icon} ${stage.name}</div>
                    <div class="stage-desc">${getStageDescription(stage.id)}</div>
                    ${actionButtons ? `<div class="stage-actions">${actionButtons}</div>` : ''}
                </div>
            </div>
            ${idx < PIPELINE_STAGES.length - 1 ? '<div class="journey-connector"></div>' : ''}
        `;
    });
    bodyHtml += '</div></div>';

    // Contact Info
    bodyHtml += `<div class="modal-section"><h3>üìá Contact Information</h3><div class="detail-grid">`;
    const contactFields = [
        ['Email', p.email],
        ['Phone', p.phone],
        ['Signal', p.signal_handle],
        ['Address', [p.street_address, p.city, p.state_province, p.postal_code, p.country].filter(Boolean).join(', ')],
        ['Birth Date', p.birth_date],
        ['Emergency Contact', [p.emergency_first_name, p.emergency_last_name].filter(Boolean).join(' ')],
        ['Emergency Phone', p.emergency_contact_phone || p.emergency_phone],
    ];
    contactFields.forEach(([label, value]) => {
        if (value) bodyHtml += `<div class="detail-item"><label>${label}</label><span>${escapeHtml(String(value))}</span></div>`;
    });
    bodyHtml += '</div></div>';

    // Admin Status
    bodyHtml += `<div class="modal-section"><h3>üè∑Ô∏è Status & Classification</h3><div class="detail-grid">`;
    const statusFields = [
        ['Pipeline Stage', p.pipeline_stage ? PIPELINE_STAGES.find(s => s.id === p.pipeline_stage)?.name : '‚Äî'],
        ['App Status', p.app_status],
        ['Acceptance', p.acceptance],
        ['Payment Status', p.payment_status],
        ['Registration', p.registration_status],
        ['Source', p._source_label],
    ];
    statusFields.forEach(([label, value]) => {
        if (value) bodyHtml += `<div class="detail-item"><label>${label}</label><span>${escapeHtml(String(value))}</span></div>`;
    });
    bodyHtml += '</div></div>';

    // Application Details (if from applications table)
    if (p._source === 'applications' || p._source === 'merged') {
        bodyHtml += `<div class="modal-section"><h3>üìù Application Details</h3><div class="detail-grid">`;
        const appFields = [
            ['Journey/Work Experience', p.journey_work_experience],
            ['Medicine Experience', p.medicine_experience],
            ['Serving Experience', p.serving_experience],
            ['Life Circumstances', p.life_circumstances],
            ['Integration Support', p.integration_support],
            ['Physical Health Issues', p.physical_health_issues],
            ['Medications (Physical)', p.physical_medications],
            ['Supplements', p.supplements],
            ['Allergies', p.allergies],
            ['Dietary Preferences', Array.isArray(p.dietary_preferences) ? p.dietary_preferences.join(', ') : p.dietary_preferences],
            ['DSM Diagnosis', p.dsm_diagnosis],
            ['Mental Health Issues', p.mental_health_issues],
            ['Psych Medications', p.psych_medications],
            ['Recreational Drug Use', p.recreational_drug_use],
            ['Stress Level', p.stress_level ? `${p.stress_level}/10` : null],
            ['Training Goals', p.training_goals],
            ['Strengths & Hobbies', p.strengths_hobbies],
        ];
        appFields.forEach(([label, value]) => {
            if (value) bodyHtml += `<div class="detail-item"><label>${label}</label><span>${escapeHtml(String(value))}</span></div>`;
        });
        bodyHtml += '</div></div>';
    }

    // Notes
    bodyHtml += `
        <div class="modal-section">
            <h3>üìù Admin Notes</h3>
            <textarea class="notes-area" id="modalNotes" placeholder="Add notes about this participant...">${escapeHtml(p.admin_notes || p.notes || '')}</textarea>
            <button class="glass-btn glass-btn-sm" style="margin-top: 0.5rem;" onclick="saveNotes('${p.email}')">Save Notes</button>
        </div>
    `;

    // Protonmail Quick Email
    bodyHtml += `
        <div class="modal-section">
            <h3>‚úâÔ∏è Send Email (via Protonmail)</h3>
            <div class="email-compose">
                <input class="glass-input" id="emailSubject" placeholder="Subject..." style="margin-bottom: 0.5rem;">
                <textarea id="emailBody" placeholder="Write your message...">${getEmailTemplate(p)}</textarea>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button class="glass-btn glass-btn-primary glass-btn-sm" onclick="sendEmail('${escapeHtml(p.email)}')">Open in Protonmail</button>
                    <button class="glass-btn glass-btn-sm" onclick="copyEmail('${escapeHtml(p.email)}')">Copy Email</button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('modalBody').innerHTML = bodyHtml;

    // Footer
    document.getElementById('modalFooter').innerHTML = `
        <div class="modal-footer-left">
            <button class="glass-btn glass-btn-sm" onclick="emailParticipant('${escapeHtml(p.email)}', '${escapeHtml(p.full_name)}')">‚úâÔ∏è Email</button>
            ${p.phone ? `<button class="glass-btn glass-btn-sm" onclick="window.open('tel:${escapeHtml(p.phone)}')">üìû Call</button>` : ''}
        </div>
        <div class="modal-footer-right">
            <button class="glass-btn glass-btn-sm" onclick="closeModal()">Close</button>
            <button class="glass-btn glass-btn-sm glass-btn-primary" onclick="advanceStage('${p.email}')">Advance Stage ‚û°Ô∏è</button>
        </div>
    `;

    document.getElementById('modalBackdrop').classList.add('open');
}

function closeModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('modalBackdrop').classList.remove('open');
}

// ===== Stage Management =====
function getStageDescription(stageId) {
    const descs = {
        lead: 'Initial contact logged in the system',
        initial_call: 'Schedule and complete discovery call',
        application: 'Review submitted application materials',
        interview: 'Conduct interview with the participant',
        approved: 'Participant approved for the retreat',
        paid: 'Send payment link and process payment',
        confirmed: 'Send course materials and finalize enrollment',
    };
    return descs[stageId] || '';
}

async function handleStageAction(email, actionId) {
    const p = mergedParticipants.find(x => x.email === email);
    if (!p) return;

    switch (actionId) {
        case 'send_stripe_link':
            // Open Protonmail compose with payment link
            const paySubject = encodeURIComponent('StepWise Training ‚Äî Payment Link');
            const payBody = encodeURIComponent(`Hi ${p.first_name || p.full_name},\n\nThank you for your application to StepWise Training! You have been approved.\n\nPlease use the following link to complete your payment:\n[Payment Link will be inserted here]\n\nIf you have any questions, please don't hesitate to reach out.\n\nWarm regards,\nStepWise Training Team`);
            window.open(`https://mail.proton.me/u/0/compose?to=${p.email}&subject=${paySubject}&body=${payBody}`, '_blank');
            showToast('Opening Protonmail to send payment link...', 'info');
            break;

        case 'send_course_link':
            const courseSubject = encodeURIComponent('StepWise Training ‚Äî Course Access');
            const courseBody = encodeURIComponent(`Hi ${p.first_name || p.full_name},\n\nCongratulations! You are confirmed for your StepWise Training retreat.\n\nHere is your link to access the pre-training course materials:\nhttps://stepwise.education/portal/course\n\nPlease complete the online modules before your retreat start date.\n\nWarm regards,\nStepWise Training Team`);
            window.open(`https://mail.proton.me/u/0/compose?to=${p.email}&subject=${courseSubject}&body=${courseBody}`, '_blank');
            showToast('Opening Protonmail to send course link...', 'info');
            break;

        case 'mark_contacted':
        case 'complete_call':
        case 'complete_review':
        case 'complete_interview':
        case 'approve':
        case 'mark_paid':
            await advanceStage(email);
            break;

        case 'schedule_call':
        case 'schedule_interview':
            const schedSubject = encodeURIComponent(`StepWise Training ‚Äî ${actionId === 'schedule_call' ? 'Discovery Call' : 'Interview'} Scheduling`);
            const schedBody = encodeURIComponent(`Hi ${p.first_name || p.full_name},\n\nThank you for your interest in StepWise Training.\n\nI'd like to schedule a ${actionId === 'schedule_call' ? 'discovery call' : 'interview'} with you. Would any of the following times work?\n\n- \n- \n- \n\nPlease let me know what works best for you.\n\nWarm regards,\nStepWise Training Team`);
            window.open(`https://mail.proton.me/u/0/compose?to=${p.email}&subject=${schedSubject}&body=${schedBody}`, '_blank');
            showToast('Opening Protonmail for scheduling...', 'info');
            break;

        case 'view_application':
            // Already in the modal, just scroll to application details
            const appSection = document.querySelector('.modal-section:nth-child(4)');
            if (appSection) appSection.scrollIntoView({ behavior: 'smooth' });
            break;
    }
}

async function advanceStage(email) {
    const p = mergedParticipants.find(x => x.email === email);
    if (!p) return;

    const currentIdx = STAGE_ORDER.indexOf(p.pipeline_stage);
    if (currentIdx >= STAGE_ORDER.length - 1) {
        showToast('Already at final stage', 'info');
        return;
    }

    const nextStage = STAGE_ORDER[currentIdx + 1];
    const nextStageName = PIPELINE_STAGES[currentIdx + 1]?.name;

    // Map pipeline stages back to applicants table status values
    const statusMap = {
        initial_call: { app_status: 'Under Review' },
        application: { app_status: 'Received' },
        interview: { app_status: 'Interview Scheduled' },
        approved: { app_status: 'Accepted', acceptance: 'Accepted' },
        paid: { payment_status: 'Paid in Full' },
        confirmed: { registration_status: 'Complete' },
    };

    const updates = statusMap[nextStage] || {};

    // Try to update the applicants table
    if (p.training_id || p._source === 'applicants' || p._source === 'merged') {
        const { error } = await sb
            .from('applicants')
            .update(updates)
            .eq('email', email);

        if (error) {
            console.warn('Could not update applicants table:', error.message);
        }
    }

    // Update local state
    p.pipeline_stage = nextStage;
    Object.assign(p, updates);

    showToast(`${p.full_name} advanced to ${nextStageName}`, 'success');
    applyFilters();
    openModal(email); // Refresh modal
}

// ===== Email Functions =====
function getEmailTemplate(participant) {
    return `Hi ${participant.first_name || participant.full_name},\n\nThank you for your interest in StepWise Training.\n\n\n\nWarm regards,\nStepWise Training Team`;
}

function emailParticipant(email, name) {
    const subject = encodeURIComponent('StepWise Training ‚Äî Follow Up');
    const body = encodeURIComponent(`Hi ${name ? name.split(' ')[0] : ''},\n\nThank you for your interest in StepWise Training.\n\n\n\nWarm regards,\nStepWise Training Team`);
    window.open(`https://mail.proton.me/u/0/compose?to=${email}&subject=${subject}&body=${body}`, '_blank');
}

function sendEmail(email) {
    const subject = encodeURIComponent(document.getElementById('emailSubject')?.value || 'StepWise Training');
    const body = encodeURIComponent(document.getElementById('emailBody')?.value || '');
    window.open(`https://mail.proton.me/u/0/compose?to=${email}&subject=${subject}&body=${body}`, '_blank');
}

function copyEmail(email) {
    navigator.clipboard.writeText(email).then(() => {
        showToast('Email copied to clipboard', 'success');
    });
}

// ===== Notes =====
async function saveNotes(email) {
    const notes = document.getElementById('modalNotes')?.value || '';

    // Try updating applicants table
    const { error } = await sb
        .from('applicants')
        .update({ notes: notes })
        .eq('email', email);

    if (error) {
        // Try applications table
        const { error: err2 } = await sb
            .from('applications')
            .update({ admin_notes: notes })
            .eq('email', email);

        if (err2) {
            showToast('Could not save notes (check RLS policies)', 'error');
            return;
        }
    }

    // Update local state
    const p = mergedParticipants.find(x => x.email === email);
    if (p) {
        p.admin_notes = notes;
        p.notes = notes;
    }

    showToast('Notes saved', 'success');
}

// ===== Tab Navigation =====
function switchTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.querySelector(`[data-tab="${tabId}"]`)?.classList.add('active');
    document.getElementById(`tab-${tabId}`)?.classList.add('active');
}

// ===== Toast Notifications =====
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
}

// ===== Utilities =====
function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// ===== Event Listeners =====
document.getElementById('searchInput').addEventListener('input', (e) => {
    searchQuery = e.target.value;
    applyFilters();
});

document.getElementById('trainingFilter').addEventListener('change', (e) => {
    currentFilter = e.target.value;
    applyFilters();
});

// Keyboard shortcut: Escape to close modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
});

// ===== Real-time Subscription =====
function setupRealtime() {
    sb
        .channel('applications-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'applications' }, (payload) => {
            console.log('Applications change:', payload);
            showToast('New application data received!', 'info');
            refreshData();
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'applicants' }, (payload) => {
            console.log('Applicants change:', payload);
            showToast('Applicant data updated!', 'info');
            refreshData();
        })
        .subscribe();
}

// ===== Initialize =====
async function init() {
    await refreshData();
    setupRealtime();
}

init();
    </script>
</body>
</html>
