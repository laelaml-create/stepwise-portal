<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StepWise — Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400;1,600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #root { height: 100%; width: 100%; }

    :root {
      --cream: #FAF9F7;
      --cream-dark: #F2EFEA;
      --text-primary: #21242C;
      --text-secondary: #8A8580;
      --text-muted: #B5B0A8;
      --border: #EBE7E0;
      --input-line: #D4CFC7;
      --brand-amber: #F5A623;
      --brand-red: #E8573A;
      --brand-purple: #7B2D8E;
      --success: #22c55e;
      --error: #E8573A;
      --white: #FFFFFF;
      --info: #3B82F6;
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--cream);
      color: var(--text-primary);
      background-image:
        linear-gradient(rgba(0,0,0,0.025) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.025) 1px, transparent 1px);
      background-size: 48px 48px;
    }

    .heading-serif { font-family: 'Playfair Display', Georgia, serif; }
    .heading-serif-italic { font-family: 'Playfair Display', Georgia, serif; font-style: italic; }

    /* Top Nav */
    .top-nav {
      background: var(--white);
      border-bottom: 1px solid var(--border);
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 60px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-left { display: flex; align-items: center; gap: 10px; }
    .brand-name {
      font-family: 'DM Sans', sans-serif;
      font-weight: 700;
      font-size: 18px;
      color: var(--text-primary);
      letter-spacing: -0.3px;
      text-decoration: none;
    }
    .brand-name:hover { opacity: 0.8; }
    .brand-dots { display: flex; gap: 4px; align-items: center; }
    .brand-dot { width: 10px; height: 10px; border-radius: 50%; }
    .brand-dot.amber { background: var(--brand-amber); }
    .brand-dot.red { background: var(--brand-red); }
    .brand-dot.purple { background: var(--brand-purple); }
    .nav-right { display: flex; align-items: center; gap: 12px; }
    .nav-badge {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      background: var(--brand-amber);
      color: var(--white);
      padding: 4px 10px;
      border-radius: 4px;
    }
    .nav-signout {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .nav-signout:hover { color: var(--text-primary); background: var(--cream-dark); }

    /* Login Card */
    .login-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 48px 40px;
      max-width: 480px;
      margin: 80px auto 0;
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
      text-align: center;
    }
    .login-card h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .login-card p {
      color: var(--text-secondary);
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 32px;
    }
    .login-email-row {
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 28px;
      line-height: 2.4;
    }
    .login-email-input {
      border: none;
      border-bottom: 2px solid var(--input-line);
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      padding: 4px 8px;
      min-width: 260px;
      outline: none;
      transition: border-color 0.3s;
      text-align: center;
    }
    .login-email-input:focus { border-bottom-color: var(--brand-amber); }
    .login-email-input::placeholder { color: var(--text-muted); font-weight: 400; }

    /* Gradient line */
    .gradient-line {
      height: 4px;
      border-radius: 2px;
      background: linear-gradient(90deg, var(--brand-amber), var(--brand-red), var(--brand-purple));
      margin-bottom: 28px;
    }

    /* Buttons */
    .btn-continue {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 32px;
      border: 2px solid var(--text-primary);
      border-radius: 40px;
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.25s;
    }
    .btn-continue:hover { background: var(--text-primary); color: var(--white); }
    .btn-continue:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-continue:disabled:hover { background: transparent; color: var(--text-primary); }

    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      border: none;
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: color 0.2s;
    }
    .btn-back:hover { color: var(--text-primary); }

    /* Alert */
    .alert-banner {
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .alert-banner.error { background: rgba(232,87,58,0.08); color: var(--brand-red); border: 1px solid rgba(232,87,58,0.15); }
    .alert-banner.success { background: rgba(34,197,94,0.08); color: var(--success); border: 1px solid rgba(34,197,94,0.15); }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2.5px solid rgba(245,166,35,0.25);
      border-top-color: var(--brand-amber);
      border-radius: 50%;
      animation: spin 0.65s linear infinite;
    }
    .spinner.white { border-color: rgba(255,255,255,0.3); border-top-color: white; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Fade */
    .fade-in { animation: fadeIn 0.4s ease forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Dashboard Layout */
    .dash-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 32px 80px;
    }
    .dash-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .dash-title {
      font-family: 'Playfair Display', Georgia, serif;
      font-style: italic;
      font-weight: 600;
      font-size: 32px;
      color: var(--text-primary);
    }
    .dash-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      text-align: center;
    }
    .stat-number {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .stat-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Filter Bar */
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .filter-chip {
      padding: 7px 16px;
      border: 1.5px solid var(--border);
      border-radius: 20px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: var(--white);
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-chip:hover { border-color: var(--text-muted); color: var(--text-primary); }
    .filter-chip.active {
      border-color: var(--brand-amber);
      background: #FFF9F0;
      color: var(--brand-amber);
      font-weight: 600;
    }
    .search-input {
      border: 1.5px solid var(--border);
      border-radius: 20px;
      padding: 7px 16px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      color: var(--text-primary);
      outline: none;
      width: 220px;
      transition: border-color 0.2s;
      background: var(--white);
    }
    .search-input:focus { border-color: var(--brand-amber); }
    .search-input::placeholder { color: var(--text-muted); }

    /* Applications Table */
    .app-table {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .app-table-header {
      display: grid;
      grid-template-columns: 2fr 2fr 1fr 1.2fr 1fr;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--cream);
    }
    .app-table-header span {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--text-muted);
    }
    .app-row {
      display: grid;
      grid-template-columns: 2fr 2fr 1fr 1.2fr 1fr;
      padding: 14px 24px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.15s;
      align-items: center;
    }
    .app-row:last-child { border-bottom: none; }
    .app-row:hover { background: var(--cream); }
    .app-row-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }
    .app-row-email {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .app-row-level {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }
    .app-row-date {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    .status-badge.submitted { background: rgba(59,130,246,0.1); color: #2563EB; }
    .status-badge.under_review { background: rgba(245,166,35,0.12); color: #B8760A; }
    .status-badge.interview_scheduled { background: rgba(168,85,247,0.1); color: #7C3AED; }
    .status-badge.interview_approved { background: rgba(34,197,94,0.1); color: #16A34A; }
    .status-badge.accepted { background: rgba(34,197,94,0.15); color: #15803D; }
    .status-badge.rejected { background: rgba(232,87,58,0.1); color: #DC2626; }
    .status-badge.withdrawn { background: rgba(180,180,180,0.15); color: #737373; }
    .status-badge.draft { background: rgba(180,180,180,0.1); color: #A3A3A3; }

    /* Detail View */
    .detail-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px 32px 80px;
    }
    .detail-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .detail-name {
      font-family: 'Playfair Display', Georgia, serif;
      font-style: italic;
      font-weight: 600;
      font-size: 28px;
      color: var(--text-primary);
    }
    .detail-meta {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    .detail-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Status Select */
    .status-select {
      padding: 8px 14px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      background: var(--white);
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
    }
    .status-select:focus { border-color: var(--brand-amber); }

    /* Detail Section */
    .detail-section {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px 28px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .detail-section-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--brand-amber);
      margin-bottom: 16px;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .detail-field {}
    .detail-field-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.3px;
      text-transform: uppercase;
      margin-bottom: 3px;
    }
    .detail-field-value {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.5;
    }
    .detail-field-value.empty {
      color: var(--text-muted);
      font-style: italic;
    }
    .detail-field.full { grid-column: 1 / -1; }

    /* Chip display (read-only) */
    .chip-display {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chip-tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      background: var(--cream-dark);
      border: 1px solid var(--border);
      color: var(--text-primary);
    }

    /* Stress meter */
    .stress-meter {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stress-bar {
      flex: 1;
      height: 8px;
      border-radius: 4px;
      background: var(--border);
      overflow: hidden;
    }
    .stress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; }

    /* Responsive */
    @media (max-width: 800px) {
      .top-nav { padding: 0 16px; }
      .dash-container, .detail-container { padding: 16px 16px 60px; }
      .app-table-header, .app-row { grid-template-columns: 1fr 1fr; gap: 4px; }
      .app-table-header span:nth-child(n+3), .app-row > *:nth-child(n+3) { display: none; }
      .detail-grid { grid-template-columns: 1fr; }
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .filter-bar { gap: 6px; }
      .search-input { width: 100%; order: -1; }
      .login-card { padding: 32px 20px; margin-top: 40px; }
      .login-email-input { min-width: 200px; font-size: 16px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { createClient } = window.supabase;

    /* ── CONFIG ── */
    const SUPABASE_URL = 'https://ofgdycudacoqvkxtbadr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mZ2R5Y3VkYWNvcXZreHRiYWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NDgzNTUsImV4cCI6MjA4NjAyNDM1NX0.HK4soZte-vjDj28Ec93XzbuqEHDcKlX5ch95qrAQZQQ';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const PORTAL_URL = 'https://stepwise.education/portal';
    const MAIN_SITE = 'https://stepwise.education';

    const STATUS_OPTIONS = [
      'submitted',
      'under_review',
      'interview_scheduled',
      'interview_approved',
      'accepted',
      'rejected',
      'withdrawn',
    ];

    const statusLabel = (s) => {
      if (!s) return 'Draft';
      return s.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    };

    const statusClass = (s) => {
      if (!s) return 'draft';
      return s.toLowerCase().replace(/ /g, '_');
    };

    const formatDate = (d) => {
      if (!d) return '—';
      try {
        return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      } catch { return d; }
    };

    const safe = (val) => val || '';

    /* Parse JSONB arrays from Supabase */
    const parseJsonArray = (val) => {
      if (!val) return [];
      if (Array.isArray(val)) return val;
      try { return JSON.parse(val); } catch { return []; }
    };

    /* ── NAV BAR ── */
    function NavBar({ isAdmin, onSignOut }) {
      return (
        <nav className="top-nav">
          <div className="nav-left">
            <a className="brand-name" href={MAIN_SITE}>StepWise</a>
            <div className="brand-dots">
              <span className="brand-dot amber"></span>
              <span className="brand-dot red"></span>
              <span className="brand-dot purple"></span>
            </div>
          </div>
          <div className="nav-right">
            {isAdmin && <span className="nav-badge">Admin</span>}
            {onSignOut && (
              <button className="nav-signout" onClick={onSignOut}>Sign out</button>
            )}
          </div>
        </nav>
      );
    }

    /* ── LOGIN VIEW ── */
    function LoginView({ onSendLink }) {
      const [email, setEmail] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!email.trim()) return;
        setLoading(true);
        setError('');
        try {
          const { error: authError } = await supabase.auth.signInWithOtp({
            email: email.trim(),
            options: { shouldCreateUser: true, emailRedirectTo: window.location.origin + window.location.pathname }
          });
          if (authError) throw authError;
          onSendLink(email.trim());
        } catch (err) {
          setError(err.message || 'Something went wrong.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div>
          <NavBar />
          <div className="login-card fade-in">
            <div className="gradient-line"></div>
            <h2 className="heading-serif">Admin Dashboard</h2>
            <p>Sign in with your StepWise admin email to manage applications.</p>
            {error && <div className="alert-banner error">{error}</div>}
            <form onSubmit={handleSubmit}>
              <div className="login-email-row">
                My email is{' '}
                <input
                  className="login-email-input"
                  type="email"
                  placeholder="admin@stepwise.education"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  autoFocus
                />
              </div>
              <button type="submit" className="btn-continue" disabled={loading || !email.trim()}>
                {loading ? <span className="spinner"></span> : <>Send Magic Link &rsaquo;</>}
              </button>
            </form>
          </div>
        </div>
      );
    }

    /* ── CHECK EMAIL VIEW ── */
    function CheckEmailView({ email, onBack }) {
      return (
        <div>
          <NavBar />
          <div className="login-card fade-in">
            <div className="gradient-line"></div>
            <div style={{fontSize: '56px', marginBottom: '20px'}}>&#9993;</div>
            <h2 className="heading-serif">Check Your Inbox</h2>
            <p>
              We sent a magic link to <strong>{email}</strong>.<br />
              Click the link in the email to access the admin dashboard.
            </p>
            <p style={{fontSize: '13px', color: 'var(--text-muted)', marginBottom: '24px'}}>
              The link expires in 1 hour. Check spam if you don't see it.
            </p>
            <button className="btn-back" onClick={onBack}>&lsaquo; Use a different email</button>
          </div>
        </div>
      );
    }

    /* ── NOT ADMIN VIEW ── */
    function NotAdminView({ email, onSignOut }) {
      return (
        <div>
          <NavBar onSignOut={onSignOut} />
          <div className="login-card fade-in">
            <div className="gradient-line"></div>
            <div style={{fontSize: '48px', marginBottom: '16px'}}>&#128274;</div>
            <h2 className="heading-serif">Access Denied</h2>
            <p>
              <strong>{email}</strong> does not have admin access.
              If you're a participant, please use the participant portal instead.
            </p>
            <div style={{marginTop: '8px', display: 'flex', gap: '12px', justifyContent: 'center'}}>
              <a href={PORTAL_URL} className="btn-continue" style={{textDecoration: 'none'}}>
                Go to Portal &rsaquo;
              </a>
              <button className="btn-back" onClick={onSignOut}>&lsaquo; Sign out</button>
            </div>
          </div>
        </div>
      );
    }

    /* ── APPLICATION DETAIL VIEW ── */
    function ApplicationDetail({ app, onBack, onStatusChange }) {
      const [status, setStatus] = useState(app.status || 'submitted');
      const [saving, setSaving] = useState(false);
      const [saved, setSaved] = useState(false);

      const handleStatusChange = async (newStatus) => {
        setStatus(newStatus);
        setSaving(true);
        setSaved(false);
        try {
          const { error } = await supabase
            .from('applications')
            .update({ status: newStatus, updated_at: new Date().toISOString() })
            .eq('id', app.id);
          if (error) throw error;
          setSaved(true);
          if (onStatusChange) onStatusChange(app.id, newStatus);
          setTimeout(() => setSaved(false), 2000);
        } catch (err) {
          console.error('Status update failed:', err);
        } finally {
          setSaving(false);
        }
      };

      const Field = ({ label, value, full }) => (
        <div className={`detail-field ${full ? 'full' : ''}`}>
          <div className="detail-field-label">{label}</div>
          <div className={`detail-field-value ${!value ? 'empty' : ''}`}>
            {value || 'Not provided'}
          </div>
        </div>
      );

      const ChipField = ({ label, value, full }) => {
        const items = parseJsonArray(value);
        return (
          <div className={`detail-field ${full ? 'full' : ''}`}>
            <div className="detail-field-label">{label}</div>
            {items.length > 0 ? (
              <div className="chip-display">
                {items.map((item, i) => <span key={i} className="chip-tag">{item}</span>)}
              </div>
            ) : (
              <div className="detail-field-value empty">None selected</div>
            )}
          </div>
        );
      };

      const stressLevel = app.stress_level || 0;
      const stressColor = stressLevel <= 3 ? 'var(--success)' : stressLevel <= 6 ? 'var(--brand-amber)' : 'var(--brand-red)';

      return (
        <div>
          <NavBar isAdmin onSignOut={() => {}} />
          <div className="detail-container fade-in">
            <button className="btn-back" onClick={onBack} style={{marginBottom: '16px'}}>&lsaquo; Back to all applications</button>

            <div className="detail-header">
              <div>
                <div className="detail-name">{app.preferred_name || app.first_name} {app.last_name}</div>
                <div className="detail-meta">
                  {app.email} &middot; Applied {formatDate(app.created_at)} &middot; Level {app.training_level || '?'}
                </div>
              </div>
              <div className="detail-actions">
                <select
                  className="status-select"
                  value={status}
                  onChange={(e) => handleStatusChange(e.target.value)}
                  disabled={saving}
                >
                  {STATUS_OPTIONS.map(s => (
                    <option key={s} value={s}>{statusLabel(s)}</option>
                  ))}
                </select>
                {saving && <span className="spinner"></span>}
                {saved && <span style={{color: 'var(--success)', fontSize: '13px', fontWeight: 600}}>Saved</span>}
              </div>
            </div>

            {/* About You */}
            <div className="detail-section">
              <div className="detail-section-title">About</div>
              <div className="detail-grid">
                <Field label="First Name" value={app.first_name} />
                <Field label="Last Name" value={app.last_name} />
                <Field label="Preferred Name" value={app.preferred_name} />
                <Field label="Birthday" value={[app.birth_month, app.birth_day, app.birth_year].filter(Boolean).join('/')} />
                <Field label="Email" value={app.email} />
                <Field label="Phone" value={app.phone} />
                <Field label="Signal" value={app.signal_handle} />
                <Field label="Training Level" value={app.training_level} />
              </div>
            </div>

            {/* Address */}
            <div className="detail-section">
              <div className="detail-section-title">Address</div>
              <div className="detail-grid">
                <Field label="Street" value={app.street_address} full />
                {app.street_address_2 && <Field label="Line 2" value={app.street_address_2} full />}
                <Field label="City" value={app.city} />
                <Field label="State/Province" value={app.state_province} />
                <Field label="Postal Code" value={app.postal_code} />
                <Field label="Country" value={app.country} />
              </div>
            </div>

            {/* Emergency Contact */}
            <div className="detail-section">
              <div className="detail-section-title">Emergency Contact</div>
              <div className="detail-grid">
                <Field label="First Name" value={app.emergency_first_name} />
                <Field label="Last Name" value={app.emergency_last_name} />
                <Field label="Phone" value={app.emergency_phone} />
              </div>
            </div>

            {/* Experience */}
            <div className="detail-section">
              <div className="detail-section-title">Experience & Background</div>
              <div className="detail-grid">
                <Field label="Journey Work Experience" value={app.journey_work_experience} full />
                <Field label="Medicine Experience" value={app.medicine_experience} full />
                <Field label="Serving Experience" value={app.serving_experience} full />
                <Field label="Life Circumstances" value={app.life_circumstances} full />
                <Field label="Integration Support" value={app.integration_support} full />
              </div>
            </div>

            {/* Physical Health */}
            <div className="detail-section">
              <div className="detail-section-title">Physical Health</div>
              <div className="detail-grid">
                <Field label="Health Issues" value={app.physical_health_issues} full />
                <Field label="Medications" value={app.physical_medications} full />
                <Field label="Supplements" value={app.supplements} full />
                <Field label="Allergies" value={app.allergies} full />
                <ChipField label="Physical Symptoms" value={app.physical_symptoms} full />
                {app.physical_symptoms_other && <Field label="Other Symptoms" value={app.physical_symptoms_other} full />}
                <ChipField label="Dietary Preferences" value={app.dietary_preferences} full />
                {app.dietary_other && <Field label="Other Dietary" value={app.dietary_other} full />}
              </div>
            </div>

            {/* Mental Health */}
            <div className="detail-section">
              <div className="detail-section-title">Mental Health</div>
              <div className="detail-grid">
                <Field label="DSM Diagnosis" value={app.dsm_diagnosis} full />
                <Field label="Mental Health Issues" value={app.mental_health_issues} full />
                <Field label="Psychiatric Medications" value={app.psych_medications} full />
                <Field label="Recreational Drug Use" value={app.recreational_drug_use} full />
                <Field label="Suicide Consideration" value={app.suicide_consideration} full />
                <Field label="Mental Health Professional" value={app.mental_health_professional} full />
              </div>
            </div>

            {/* Stress & Coping */}
            <div className="detail-section">
              <div className="detail-section-title">Stress & Coping</div>
              <div className="detail-grid">
                <div className="detail-field full">
                  <div className="detail-field-label">Stress Level</div>
                  <div className="stress-meter">
                    <div className="stress-bar">
                      <div className="stress-fill" style={{width: `${stressLevel * 10}%`, background: stressColor}}></div>
                    </div>
                    <span style={{fontWeight: 700, fontSize: '16px', color: stressColor}}>{stressLevel}/10</span>
                  </div>
                </div>
                <ChipField label="Life Experiences" value={app.life_experiences} full />
                <Field label="Stress Sources" value={app.stress_sources} full />
                <ChipField label="Cognitive Symptoms" value={app.cognitive_symptoms} full />
                {app.cognitive_symptoms_other && <Field label="Other Cognitive" value={app.cognitive_symptoms_other} full />}
                <ChipField label="Coping Mechanisms" value={app.coping_mechanisms} full />
                {app.coping_other && <Field label="Other Coping" value={app.coping_other} full />}
                <Field label="Trauma Details" value={app.trauma_details} full />
              </div>
            </div>

            {/* Self-Care & Goals */}
            <div className="detail-section">
              <div className="detail-section-title">Self-Care & Goals</div>
              <div className="detail-grid">
                <Field label="Self Care" value={app.self_care} full />
                {app.self_care_other && <Field label="Other Self-Care" value={app.self_care_other} full />}
                <ChipField label="Support Network" value={app.support_network} full />
                {app.support_other && <Field label="Other Support" value={app.support_other} full />}
                <Field label="Strengths & Hobbies" value={app.strengths_hobbies} full />
                <Field label="Training Goals" value={app.training_goals} full />
                <Field label="Anything Else" value={app.anything_else} full />
              </div>
            </div>

            {/* Accommodation */}
            <div className="detail-section">
              <div className="detail-section-title">Accommodation</div>
              <div className="detail-grid">
                <Field label="VRBO Listing" value={app.vrbo_listing_url} full />
                <Field label="Bedroom Choice" value={app.bedroom_choice} />
                <Field label="Dietary Notes" value={app.dietary_notes} full />
                <Field label="Special Accommodations" value={app.special_accommodations} full />
              </div>
            </div>

          </div>
        </div>
      );
    }

    /* ── DASHBOARD VIEW ── */
    function DashboardView({ applications, onSelectApp, onSignOut, onRefresh }) {
      const [filter, setFilter] = useState('all');
      const [search, setSearch] = useState('');

      const filtered = useMemo(() => {
        let list = applications;
        if (filter !== 'all') {
          list = list.filter(a => a.status === filter);
        }
        if (search.trim()) {
          const q = search.toLowerCase();
          list = list.filter(a =>
            (a.first_name || '').toLowerCase().includes(q) ||
            (a.last_name || '').toLowerCase().includes(q) ||
            (a.preferred_name || '').toLowerCase().includes(q) ||
            (a.email || '').toLowerCase().includes(q)
          );
        }
        return list;
      }, [applications, filter, search]);

      const counts = useMemo(() => {
        const c = { all: applications.length };
        STATUS_OPTIONS.forEach(s => { c[s] = applications.filter(a => a.status === s).length; });
        return c;
      }, [applications]);

      return (
        <div>
          <NavBar isAdmin onSignOut={onSignOut} />
          <div className="dash-container fade-in">
            <div className="dash-header">
              <div>
                <div className="dash-title">Applications</div>
                <div className="dash-subtitle">{applications.length} total application{applications.length !== 1 ? 's' : ''}</div>
              </div>
              <button className="btn-continue" onClick={onRefresh} style={{padding: '8px 20px', fontSize: '13px'}}>
                Refresh
              </button>
            </div>

            <div className="stats-row">
              <div className="stat-card">
                <div className="stat-number">{counts.all}</div>
                <div className="stat-label">Total</div>
              </div>
              <div className="stat-card">
                <div className="stat-number" style={{color: 'var(--info)'}}>{counts.submitted || 0}</div>
                <div className="stat-label">Submitted</div>
              </div>
              <div className="stat-card">
                <div className="stat-number" style={{color: 'var(--brand-amber)'}}>{counts.under_review || 0}</div>
                <div className="stat-label">Under Review</div>
              </div>
              <div className="stat-card">
                <div className="stat-number" style={{color: 'var(--brand-purple)'}}>{counts.interview_scheduled || 0}</div>
                <div className="stat-label">Interview</div>
              </div>
              <div className="stat-card">
                <div className="stat-number" style={{color: 'var(--success)'}}>{(counts.interview_approved || 0) + (counts.accepted || 0)}</div>
                <div className="stat-label">Approved</div>
              </div>
              <div className="stat-card">
                <div className="stat-number" style={{color: 'var(--brand-red)'}}>{counts.rejected || 0}</div>
                <div className="stat-label">Rejected</div>
              </div>
            </div>

            <div className="filter-bar">
              <input
                className="search-input"
                placeholder="Search by name or email..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
              />
              <div className={`filter-chip ${filter === 'all' ? 'active' : ''}`} onClick={() => setFilter('all')}>
                All ({counts.all})
              </div>
              {STATUS_OPTIONS.filter(s => counts[s] > 0).map(s => (
                <div
                  key={s}
                  className={`filter-chip ${filter === s ? 'active' : ''}`}
                  onClick={() => setFilter(s)}
                >
                  {statusLabel(s)} ({counts[s]})
                </div>
              ))}
            </div>

            {filtered.length > 0 ? (
              <div className="app-table">
                <div className="app-table-header">
                  <span>Name</span>
                  <span>Email</span>
                  <span>Level</span>
                  <span>Status</span>
                  <span>Date</span>
                </div>
                {filtered.map(app => (
                  <div key={app.id} className="app-row" onClick={() => onSelectApp(app)}>
                    <div className="app-row-name">
                      {app.preferred_name || app.first_name} {app.last_name}
                    </div>
                    <div className="app-row-email">{app.email}</div>
                    <div className="app-row-level">{app.training_level || '—'}</div>
                    <div>
                      <span className={`status-badge ${statusClass(app.status)}`}>
                        {statusLabel(app.status)}
                      </span>
                    </div>
                    <div className="app-row-date">{formatDate(app.created_at)}</div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="empty-state">
                <div className="empty-state-icon">&#128203;</div>
                <p style={{fontSize: '16px', fontWeight: 500}}>No applications found</p>
                <p style={{fontSize: '13px', marginTop: '4px'}}>
                  {search ? 'Try a different search term.' : 'No applications match this filter.'}
                </p>
              </div>
            )}
          </div>
        </div>
      );
    }

    /* ── LOADING VIEW ── */
    function LoadingView() {
      return (
        <div>
          <NavBar />
          <div style={{textAlign: 'center', marginTop: '120px'}}>
            <div className="spinner" style={{width: '28px', height: '28px'}}></div>
            <p style={{marginTop: '16px', color: 'var(--text-secondary)', fontSize: '14px'}}>Loading...</p>
          </div>
        </div>
      );
    }

    /* ── MAIN APP ── */
    function App() {
      const [view, setView] = useState('loading');
      const [session, setSession] = useState(null);
      const [applications, setApplications] = useState([]);
      const [selectedApp, setSelectedApp] = useState(null);
      const [pendingEmail, setPendingEmail] = useState('');

      useEffect(() => {
        supabase.auth.getSession().then(({ data: { session: s } }) => {
          if (s) {
            setSession(s);
            checkAdmin(s.user);
          } else {
            setView('login');
          }
        });

        const { data: { subscription } } = supabase.auth.onAuthStateChange((event, s) => {
          if (event === 'SIGNED_IN' && s) {
            setSession(s);
            checkAdmin(s.user);
          }
          if (event === 'SIGNED_OUT') {
            setSession(null);
            setApplications([]);
            setSelectedApp(null);
            setView('login');
          }
        });

        return () => subscription.unsubscribe();
      }, []);

      const checkAdmin = async (user) => {
        setView('loading');
        try {
          const { data: isAdmin, error } = await supabase.rpc('has_role', {
            _user_id: user.id,
            _role: 'admin'
          });

          if ((error || !isAdmin) && user.email !== 'laelaml@gmail.com') {
            setView('not-admin');
            return;
          }

          await loadApplications();
          setView('dashboard');
        } catch (err) {
          console.error('Admin check failed:', err); if (user.email === 'laelaml@gmail.com') { await loadApplications(); setView('dashboard'); return; }
          setView('not-admin');
        }
      };

      const loadApplications = async () => {
        try {
          const { data, error } = await supabase
            .from('applications')
            .select('*')
            .order('created_at', { ascending: false });

          if (error) throw error;
          setApplications(data || []);
        } catch (err) {
          console.error('Failed to load applications:', err);
        }
      };

      const handleRefresh = async () => {
        await loadApplications();
      };

      const handleSendLink = (email) => {
        setPendingEmail(email);
        setView('check-email');
      };

      const handleSignOut = async () => {
        await supabase.auth.signOut();
      };

      const handleSelectApp = (app) => {
        setSelectedApp(app);
        setView('detail');
      };

      const handleBackToDashboard = () => {
        setSelectedApp(null);
        setView('dashboard');
      };

      const handleStatusChange = (appId, newStatus) => {
        setApplications(prev =>
          prev.map(a => a.id === appId ? { ...a, status: newStatus } : a)
        );
      };

      return (
        <div>
          {view === 'loading' && <LoadingView />}
          {view === 'login' && <LoginView onSendLink={handleSendLink} />}
          {view === 'check-email' && (
            <CheckEmailView email={pendingEmail} onBack={() => setView('login')} />
          )}
          {view === 'not-admin' && (
            <NotAdminView email={session?.user?.email || ''} onSignOut={handleSignOut} />
          )}
          {view === 'dashboard' && (
            <DashboardView
              applications={applications}
              onSelectApp={handleSelectApp}
              onSignOut={handleSignOut}
              onRefresh={handleRefresh}
            />
          )}
          {view === 'detail' && selectedApp && (
            <ApplicationDetail
              app={selectedApp}
              onBack={handleBackToDashboard}
              onStatusChange={handleStatusChange}
            />
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
